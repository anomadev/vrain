El procesamiento de formularios en PHP implica capturar datos de los usuarios a través de `$_GET` o `$_POST`, validarlos y sanitizarlos para evitar inyecciones y errores, y responder adecuadamente (redirigir, mostrar mensajes de error o procesar lógicamente). PHP facilita esto con la superglobal `$_SERVER['REQUEST_METHOD']` ([[8.2 Super Global Variables]]), funciones de filtrado (`filter_input()`, `filter_var()`), saneamiento (`htmlspecialchars()`, `strip_tags()`), y manejo de errores integrado (`json_last_error()`, `json_last_error_msg()`).

---
### Definición
- **Formulario HTML**: Conjunto de elementos `<form>` con atributos `action` (destino PHP) y `method` (`get`/`post`), que envían datos al servidor cuando el usuario lo envía.
- **Captura de datos**: En PHP, los valores llegan a `$_GET` (`query string`) o `$_POST` (cuerpo del `request`), y pueden combinarse en `$_REQUEST`.
- **Validación**: Verificar que los datos cumplen un formato esperado (números, emails, cadenas) con `filter_var()` o expresiones regulares.
- **Saneamiento**: Limpiar datos peligrosos con `htmlspecialchars()`, `strip_tags()` o filtros de sanitización de `filter_input()`.

---
### Conceptos Clave
##### Estructura Básica de un Formulario
```html
<form action="procesar.php" method="post">
  <label>Nombre:</label>
  <input name="name" type="text">
  <label>Edad:</label>
  <input name="age" type="number">
  <button type="submit">Enviar</button>
</form>
```
Cuando se envía, PHP recibe los valores en `$_POST['name']` y `$_POST['age']`.
##### Comprobación del Método
```php
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    exit('Método no permitido');
}
```
Así evitas procesar `GET` como si fueran datos de formulario.
##### Validación y Saneamiento
Emails:
```php
$email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
if (!$email) { $errors[] = 'Email inválido.'; }
```
Cadenas de caracteres:
```php
$name = htmlspecialchars($_POST['name'], ENT_QUOTES, 'UTF-8');
```
Cadenas libres de etiquetas:
```php
$bio = strip_tags($_POST['bio']);
```
##### Múltiples Errores y Redisplay
Recopila errores en un array y vuelve a mostrar el formulario con valores previos:
```php
$errors = [];
if (empty($_POST['name'])) {
    $errors['name'] = 'Nombre obligatorio';
}
// …
if ($errors) {
    // Volver a mostrar formulario con errores y valores de $_POST
}
```
##### Protección CSRF Básica
Genera un token de sesión: 
```php
// En el formulario
$_SESSION['token'] = bin2hex(random_bytes(32));
<input type="hidden" name="token" value="<?= $_SESSION['token'] ?>">

// Al procesar
if (!hash_equals($_SESSION['token'], $_POST['token'])) {
    exit('Token CSRF inválido');
}
```

---
### Ejemplos Prácticos
##### Formulario de Registro
```php
<?php

session_start();
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // CSRF
    if (!hash_equals($_SESSION['token'], $_POST['token'])) {
        exit('CSRF fail');
    }
    // Validar
    $email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
    $pass  = $_POST['password'];
    if (!$email) $errors['email']='Email inválido';
    if (strlen($pass)<8) $errors['password']='Mínimo 8 caracteres';
    if (!$errors) {
        // Guardar usuario
    }
}

$_SESSION['token'] = bin2hex(random_bytes(32));
?>

<form method="post">
  <input name="email">
  <?= $errors['email'] ?? '' ?>
  <input type="password" name="password">
  <?= $errors['password'] ?? '' ?>
  <input type="hidden" name="token" value="<?= $_SESSION['token'] ?>">
  <button>Registrar</button>
</form>
```
##### Carga de Archivos
```php
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['avatar'])) {
    $file = $_FILES['avatar'];
    if ($file['error'] === UPLOAD_ERR_OK) {
        $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
        
        if (in_array($ext, ['jpg','png'])) {
            move_uploaded_file($file['tmp_name'], "uploads/{$file['name']}");
        } else {
            $errors['avatar']='Formato no soportado';
        }
    }
}
```
Usa `$_FILES` para gestionar `uploads` (`enctype="multipart/form-data"`)
##### Envió y Manejo de JSON
Si recibes un formulario vía AJAX:
```php
$data = json_decode(file_get_contents('php://input'), true);
$name = filter_var($data['name'], FILTER_SANITIZE_STRING);
```
Combina `php://input` y filtros para `APIs`.

---
## ✍️ Notas
- Combinar `filter_input()` con validación de expresiones regulares para garantizar robustez.
- Usar `tokens CSRF` incluso en formularios `AJAX`  para maximizar la seguridad.
