PHP facilita las subidas de archivos mediante el uso de formularios HTML con `enctype="multipart/form-data"`y la superglobal `$_FILES`, que expone datos clave como nombre, tipo MIME, ruta temporal, tamaño y código de error.
El comportamiento de carga se controla con directivas de `php.ini` como `file_uploads`, `upload_max_filesize`, `post_max_size` y `max_file_uploads`, que establecen límites y ubicación de archivos temporales.
Al procesar la carga, es esencial validar tanto el código de error (`UPLOAD_ERR_*`) como el contenido real con funciones como `is_uploaded_file()` y `finfo_file()`, y usar `move_uploaded_file()` para transferir el archivo de forma segura a su destino. 
En escenarios de múltiples archivos, el formulario debe usar `name="userfile[]"` y PHP organizará automáticamente los datos en `arrays` ([[3.1 Arrays]]). 

---
### Definición
- Subida de archivos: Proceso en el que un cliente envía ficheros (texto, imágenes, binarios) al servidor web mediante un formulario HTML con `method="post"` y `enctype="multipart/form-data"`.
- `$_FILES`: Superglobal en PHP ([[8.2 Super Global Variables]]) que almacena un `array` asociativo por cada campo `<input type="file">`, conteniendo las claves:
	- `name`: nombre original en el cliente.
	- `type`: tipo MIME reportado por el navegador.
	- `tmp_name`: ruta al archivo temporal en el servidor.
	- `error`: código de error de la carga
	- `size`: tamaño en bytes.

---
### Conceptos Clave
1. **Configuración en `php.ini`** ([[20.4 Configuration Files]])
	- `file_uploads = On` habilita subidas de archivos
	- `upload_max_filesize` define el tamaño máximo por archivo
	- `post_max_size` debe ser mayor o igual a `upload_max_filesize` para permitir formularios grandes.
	- `upload_tmp_dir` especifica dónde PHP guarda los archivos antes de moverlos.
	- `max_file_uploads` limita el número de archivos por petición (default 20).
2. **Estructura del formulario HTML**
```html
<form action="upload.php" method="post" enctype="multipart/form-data">
	<label> Seleccionar archivo:
		<input type="file" name="userfile">
	</label>
	<button type="submit">Subir</button>
</form>
```
Debe incluir `enctype="multipart/form-data"`.
3. **Manejo de `$_FILES` y Errores**
```php
if ($_FILES['userfile']['error'] !== UPLOAD_ERR_OK) {
	// Manejar error
}
```
Antes de procesar, verificar el código de error. Códigos de error incluyen `UPLOAD_ERR_INI_SIZE`, `UPLOAD_ERR_FORM_SIZE`, `UPLOAD_ERR_NO_FILE`.
4. **Transferencia segura con `move_uploaded_file`**: `is_uploaded_file($tmp)` y `move_uploaded_file($tmp, $dest)` garantizan que el archivo proviene de una subida HTTP y evita `exploits` de ficheros locales.
5. **Validación y Seguridad**:
	- No confiar en `$_FILES['type']`; usar `Fileinfo`
	- Validar el tamaño con `$_FILES['size']` y comparar contra `upload_max_filesize`.
	- Generar nombres únicos (ej. `uniqid` o hash) para evitar colisiones y `path traversal`.
6. **Subida de múltiples archivos**:
```HTML
<!-- En el formulario -->
<input name="userfile[]" type="file" multiple>
```
PHP crea `arrays` en `$_FILES['userfile']['name'][0..n]`.

---
### Ejemplos Prácticos
##### Subida sencilla y segura
```php
<?php

if ($_SERVER['REQUEST_METHOD']==='POST') {
    $file = $_FILES['userfile'];
    if ($file['error'] === UPLOAD_ERR_OK) {
        $tmp  = $file['tmp_name'];
        $name = basename($file['name']);
        $dest = "uploads/".uniqid()."_".$name;
        if (is_uploaded_file($tmp)) {
            move_uploaded_file($tmp, $dest);
            echo "Archivo subido a $dest";
        }
    }
}
```
##### Validación de tipo con `Fileinfo`
```php
<?php

$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mime  = finfo_file($finfo, $_FILES['userfile']['tmp_name']);
if (!in_array($mime, ['image/jpeg','image/png'])) {
    die('Formato no permitido');
}
```
##### Subida de múltiples imágenes
```php
<?php

foreach ($_FILES['userfile']['tmp_name'] as $i => $tmp) {
    if ($_FILES['userfile']['error'][$i]===UPLOAD_ERR_OK
        && is_uploaded_file($tmp)) {
        move_uploaded_file($tmp, "uploads/".uniqid()."_".basename($_FILES['userfile']['name'][$i]));
    }
}
```
##### Detectar y manejar errores de tamaño
```php
if ($_FILES['userfile']['error'] === UPLOAD_ERR_INI_SIZE ||
    $_FILES['userfile']['error'] === UPLOAD_ERR_FORM_SIZE) {
    echo 'El archivo supera el límite permitido';
}
```
##### Límite en lado del cliente
```html
<input type="hidden" name="MAX_FILE_SIZE" value="2097152">
```
Debe ser menor o igual a `upload_max_filesize`

---
## ✍️ Notas

- Validar siempre el `MIME` real con `Fileinfo` antes de aceptar el archivo.
- Utilizar nombre únicos (`uniqid()`) para evitar sobreescrituras en directorios de `uploads`.
- Para proyectos grandes, implementar un `middleware` que verifique errores de subida y tamaños antes de llegar al controlador.
