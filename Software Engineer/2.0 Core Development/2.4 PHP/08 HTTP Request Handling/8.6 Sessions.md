Las sesiones en PHP permiten mantener estado entre múltiples peticiones HTTP asociando datos de usuario a un identificador único (`session ID`) que ese envía y recibe automáticamente a través de cookies ([[8.5 State Management (Cookies)]]). Al invocar `session_start()`. PHP recupera datos previos de `$_SESSION` si existe un ID válido, o crea uno nuevo si no lo hay, cargando la variable superglobal `$_SESSION` con los datos almacenados. Al finalizar el script PHP serializa y guarda automáticamente `$_SESSION` usando el `session handler` configurado (por defecto, archivos en disco bajo `session.save_path`). Para liberar el bloqueo de sesión antes de que termine el script (útil en múltiples peticiones concurrentes o AJAX), se usa `session_write_close()` tras las modificaciones necesarias.

---
### Definiciones Principales
- `session_start()`: Inicia una nueva sesión o reanuda la existente, asegurándose de que `$_SESSION` esté disponible. Debe invocarse antes de enviar cualquier salida al navegador.
- `$_SESSION`: Variable superglobal ([[8.2 Super Global Variables]]) tipo array donde se almacena y recupera la información de la sesión para el usuario actual.
- `session_write_close()`: Escribe los datos en `$_SESSION` al almacenamiento y libera el bloqueo del archivo de sesión, permitiendo otras peticiones concurrentes.
- `session.save_handler` / `sassion.save_path`: Directivas en `php.ini` ([[20.4 Configuration Files]]) que configuran el `handler` (p. ej. `files`) y la ruta para guardar datos de sesión en el servidor.

---
### Conceptos Clave
1. **Ciclo de Vida de la Sesión**
	- Inicio: `session_start()` lee la cookie con el `session ID` y carga `$_SESSION`; si no existe, genera un nuevo ID.
	- Uso: Lectura/Escritura en `$_SESSION` durante el script.
	- Cierre: Al finalizar, PHP serializa y guarda `$_SESSION`; el bloqueo de archivo se libera automáticamente o con `session_write_close()`.
2. **Bloqueo de Sesiones y Concurrencia**: PHP bloque el archivo de sesión al iniciar con `session_start()`, evitando que otras peticiones del mismo usuario lo modifiquen simultáneamente. Para mejorar la concurrencia (p. ej. en AJAX), se recomienda llamar a `session_write_close()` tan pronto como se hayan guardado los cambios esenciales en `$_SESSiON`.
3. **Almacenamiento Predeterminado**: Por defecto, PHP usa el `save handler files`, guardando sesiones en archivos dentro del directorio `session.save_path`, típicamente `/var/lib/php/sessions` o similar. Esto puede cambiarse a bases de datos o sistemas de caché mediante `handlers` personalizados.
4. **Buenas prácticas:**
	- Validar existencias de índices en `$_SESSION` antes de acceder (`isset`) para evitar `undefined index`.
	- No usar referencias en `$_SESSION` (no restaurables tras la serialización).
	- Regenerar ID (`session_regenerate_id()`) tras eventos críticos (`login`/`logout`) para prevenir `session fixation`.
	- Configurar directivas de seguridad como `session.cookie_httponly` y `session.cookie_secure` en `php.ini` ([[20.4 Configuration Files]]).

---
### Ejemplos Prácticos
##### Contador de Visitas
```php
<?php

session_start();

// Inicialización o incrementar contador
if (!isset($_SESSION['visitas'])) {
	$_SESSION['visitas'] = 1;
} else {
	$_SESSION['visitas']++;
}
echo "Visitas: " . $_SESSION['visitas'];
```
Segmenta un contador por usuario usando `$_SESSION`.
##### Cerrar Sesión Anticipadamente
```php
<?php

session_start();
$_SESSION['step1'] = $data;
// Guardar y liberar bloqueo para siguiente paetición rápida por AJAX

session_write_close();
// Realizar trabajo pesado...
```
Mejora respuesta de peticiones concurrentes sin esperar a fin de script.
##### Eliminar Variable de Sesión
```php
<?php

session_start();
unset($_SESSION['visitas']); // elimina contador
// No usar unset($_SESSION), rompe manejo de sesión
```
Quita datos específicos sin destruir la sesión completa.
##### Registrar ID en Login
```php
<?php

session_start();
// Tras validar credenciales
session_regenerate_id(true);
$_SESSION['user_id'] = $user->id;
```
Previene `session fixation` invalidando el viejo ID.
##### Configurar Sesiones en Base de Datos
```php
// En script de arranque o ServiceProvider
ini_set('session.save_handler', 'redis');
ini_set('session.save_path', 'tcp://127.0.0.1:6379');
session_start();
```
Mejora escalabilidad con un `store` compartido.
