> [!info] Autoloading (Roadmap SH)
> La carga automática es una característica conveniente en PHP que permite la carga automática de clases o archivos cuando son necesarios. Por ejemplo, si tiene una clase que aún no está incluida o no es requerida en el script, y está instanciado en clase, PHP incluirá automáticamente ese archivo de clase para usted, siempre que cumplas con las convenciones de carga automática estándar de PHP.

El `autoloading` en PHP es el mecanismo que carga automáticamente el código de clases ([[11.1 Classes and Objects]]), interfaces ([[11.9 Interfaces]]), `traits` ([[11.10 Traits]]), o enumeraciones cuando se usan, sin necesidad de un `require` manual para cada archivo. Con `spl_autoload_register()`, registras una o varias funciones que PHP invoca la primera vez que encuentra un nombre de clase no definido, dando la "última oportunidad" de cargarla antes de lanzar un error. Esta práctica elimina las largar listas de `include` al inicio de cada script, mejora el rendimiento al cargar solo lo necesario y combinado con `PSR-4` ([[18.1 PHP Framework Interoperability Group]]) y `Composer` ([[13.1 Composer]]), estandariza la organización y descubrimiento de clases en proyectos grandes.

### Contenido Clave
##### Registrar `autoloaders`
```php
spl_autoload_register(function (string $className): void {
	include __DIR__ . '/src/' . str_replace('\\', '/', $className) . '.php';
});
```
- PHP ejecuta esta función si `new My\ClassName()` no encuentra la definición en memoria.
- Puedes registrar múltiples `autoloaders`; se llaman en secuencia hasta que uno carga la clase o todas fallan.
##### Deprecación de `__autoload()`
Antes de PHP 7.2 existía `__autoload()`, pero es menos flexible (solo uno) y desde PHP 8.0 fue eliminado en favor de `spl_autoload_register()`.
##### `PSR-4` y `Composer`
Con `Composer` defines en `composer.json`:
```json
"autoload": {
	"psr-4": {
		"App\\": "src/"
	}
}
```
- Luego `composer dump-autoload` genera un `autoloader` que respeta `namespaces` y rutas, basándose en `PSR-4`.
##### Orden y Prioridad
`spl_autoload_register($fn, true, true)` registra `$fn` al frente de la cola (`prepend=true`), ejecutándose antes que otros.

### Analogías
- Guardian de biblioteca: En lugar de pedir al lector que traiga cada libro (clase) antes de usarlo (`require`), el guardián (`spl_autoload_register`) escucha el título que buscas y te lo proporciona automáticamente desde el depósito.
- Mapa de calles y direcciones: PSR-4 ([[18.1 PHP Framework Interoperability Group]]) mapea `namespaces` ([[11.11 Namespaces]]) a carpetas como un sistema de direcciones; cuando buscas `App\Controllers\HomeController`, el `autoloader` sabe buscar en `src/Controllers/HomeController.php`.

### Ejemplos 
##### `Autoloader` manual simple
```php
<?php

spl_autoload_register(function (string $class) {
	$path = __DIR__ . '/classes/' . $class . '.php';
	if (file_exists($path)) {
		require $path;
	}
});

$u = new User();     // carga classes/User.php
$p = new Product();  // carga classes/Product.php
```
##### `Autoload` con `Namespace` y `PSR-4` (`Composer`)
```json
// composer.json
{
	"autoload": {
		"psr-4": {
			"App\\": "src/"
		}
	}
}
```

```bash
composer dump-autoload
```

```php
<?php

require 'vendor/autoload.php';

use App\Models\User;

$user = new User(); // Composer autoloader carga src/Models/User.php
```

### Notas
- Configurar `namespaces` ([[11.11 Namespaces]]) de acuerdo a la estructura de carpetas para que `Composer` ([[13.1 Composer]]) encuentre clases sin ajustes adicionales.
- Nunca lanzar excepciones en funciones registradas con `spl_autoload_register()`: pueden detener otros `autoloaders`, generando errores inesperados.
- Revisar `composer dump-autoload -o` para optimizar el `autoloader` en producción (optimizado, mapea todas las clases de forma estática).
