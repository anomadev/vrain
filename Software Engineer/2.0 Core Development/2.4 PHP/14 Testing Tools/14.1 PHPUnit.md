> [!info] PHPUnit (Roadmap SH)
> `PHPUnit` es un framework de pruebas ampliamente utilizado en PHP. Las pruebas automatizadas permiten a los desarrolladores garantizar que su código funciones según lo previsto. Con `PHPUnit`, puedes escribir casos de prueba en PHP para comprobar la funcionalidad de tu código base. Es especialmente útil para ejecutar pruebas unitarias (pruebas que verifican partes individuales del software). `PHPUnit` admite varios tipos de aserciones, lo que lo hace versátil para cualquier requisito de prueba.

`PHPUnit` es el framework de facto para pruebas unitarias en PHP. Con él defines `tests` (clases que extienden `PHPUnit\Framework\TestCase`) y usas `assertions` (`assertEquals`, `assertTrue`, etc.) para verificar que tus unidades de código se comportan como esperas. `PHPUnit` se instala como un `PHAR` o con `Composer` ([[13.1 Composer]]), detecta automáticamente `tests` de un directorio (p. ej. `tests` ) y puede configurarse con un archivo `phpunit.xml`. Dominar su uso te permite **detectar errores temprano, documentar** contratos de código y mantener la calidad a medida que tu aplicación crece.

### Contenido Clave
##### Instalación
```bash
# PHAR
wget -O phpunit https://phar.phpunit.de/phpunit-7.phar
chmod +x phpunit
./phpunit --version      # PHPUnit 7.x
```

```bash
# composer (recomendado para proyectos)
composer require --dev phpunit/phpunit ^7
./vendor/bin/phpunit --version
```
##### Estructura de directorios
```bash
project/
├── src/                  # Código de producción
├── tests/                # Tests unitarios (*.php)
│   └── UserTest.php
├── phpunit.xml           # Configuración (opcional)
├── composer.json
└── vendor/               # Paquetes instalados (incluyendo phpunit)
```
##### Escribir un `test` básico
```php
<?php

// tests/CalculatorTest.php
use PHPUnit\Framework\TestCase;

class CalculatorTest extends TestCase {
	private $calc;

	protected function setUp(): void {
		$this->calc = new Calculator();
	}

	public function testAddReturnSum(): void {
		$result = $this->calc->add(2,3);
		$this->assertEquals(5, $result);
	}

	public function testDivideByZeroThrows(): void {
		$this->expectException(DivisionByZeroError::class);
		$this->calc->divide(5, 0);
	}
}
```
- `setUp()`: se ejecuta antes de cada `test` para preparar el entorno.
- `assertEquals()`, `assertTrue()`, `assertCount()`, etc., son los métodos de verificación.
- `expectException` anticipa excepciones.
##### Ejecutar los `test`
```bash
# Con PHAR
./phpunit --configuration phpunit.xml
# Con Composer
./vendor/bin/phpunit --configuration phpunit.xml
```
Si no hay `phpunit.xml`, `PHPUnit` busca `tests` en `tests/` y usa valores por defecto.
##### Configuración (`phpunit.xml`)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit bootstrap="vendor/autoload.php" colors="true">
  <testsuites>
    <testsuite name="Unit Tests">
      <directory>tests</directory>
    </testsuite>
  </testsuites>
  <coverage processUncoveredFiles="true">
    <include>
      <directory>src</directory>
    </include>
  </coverage>
</phpunit>
```
- `bootstrap`: carga el `autoloader` ([[13.3 Autoloading]]) de `Composer` ([[13.1 Composer]])
- `testsuites`: define dónde buscar `tests`
- `coverage` (con `Xdebug/PHPBG`): genera reportes de cobertura de código

### Analogías
- **Oficina de control de calidad**: `PHPUnit` es el inspector que ejecuta una batería de chequeos (`tests`) para garantizar que cada componente (clase o función) cumple con sus especificaciones antes de pasar a producción.
- **Lista de verificación de viaje**: Antes de viajar, revisas equipaje, documentos, reservas. `PHPUnit` corre tu "`checklist`" de `tests` para asegurarte de que nada falte y el viaje (despliegue) sea exitoso.

### Ejemplos Prácticos
##### `test` de servicio de usuario
```php
<?php
// src/UserService.php
class UserService {
	public function isAdult(int $age): bool {
		return $age >= 18;
	}
}

// tests/UserServiceTest.php
use PHPUnit\Framework\TestCase;

class UserServiceTest extends TestCase {
	public function testIsAdultTrue(): void {
		$svc = new UserSevice();
		$this->assertTrue($svc->isAdult(20));
	}

	public function testIsAdultFalse(): void {
		$svc = new UserService();
		$this->assertFalse($svc->isAdult(16));
	}
}
```

```bash
./vendor/bin/phpunit
```
##### Cobertura de código
```bash
./vendor/bin/phpunit --coverage-html coverage/
```
Genera un reporte en `coverage/index.html` mostrando qué parte de `src/` no tienen `tests`.
##### Integración Continua (`GitHub Actions`)
```yaml
# .github/workflows/phpunit.yml
name: Run Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
      - name: Install Dependencies
        run: composer install --no-progress --no-interaction --prefer-dist
      - name: Run PHPUnit
        run: vendor/bin/phpunit --colors=never --verbose
      - name: Upload Coverage
        if: success()
        uses: codecov/codecov-action@v3
        with:
          files: coverage/*.xml
```

