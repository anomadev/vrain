> [!info] Psalm (Roadmap SH)
> `Psalm` es una popular herramienta de análisis estático diseñada para PHP. Identifica posibles problemas en el código para PHP. Identifica posibles problemas en el código, como errores de sintaxis, variables no utilizadas y discrepancias de tipos, antes de ejecutarlo. Esto ayuda a mejorar la calidad y la mantenibilidad del código. Es bastante potente, incluso puede comprender escenarios complejos mediante su sistema de plantillas/interfaz. Para analizar su código PHP con `Psalm`, simplemente necesita instalarlo y luego ejecutarlo contra su archivo o directorio PHP.

`Psalm` es una herramienta de análisis estático de código abierto, creada y mantenida por el equipo de Vimeo. Al igual que `PHPStan`, su propósito es encontrar errores en el código PHP sin necesidad de ejecutarlo. Se especializa en una inferencia de tipos muy avanzada, en la detección de errores sutiles y notablemente, en su capacidad para corregir automáticamente muchos de los problemas que detecta.

**Analogía**: Siguiendo con nuestra editorial, si `PHPStan` ([[16.1 PHPStan]]) es el "editor de contenido", meticuloso, `Psalm` es el "editor técnico" con superpoderes. No solo lee el manuscrito para encontrar errores lógicos, sino que es tan bueno deduciendo las intenciones del autor (inferencia de tipos) que a menudo puede reescribir frases para mejorarlas (auto-corrección de código). Además, tiene un departamento de seguridad que investiga si alguna fuente de información "sucia" (como un formulario de un usuario anónimo) llega a partes críticas del libro (una consulta a la base de datos), previniendo escándalos (vulnerabilidades de seguridad).

### Conceptos Clave
- **Creado por Vimeo**: Nació de la necesidad de mantener una base de código PHP masiva y compleja, por lo que está diseñado con un enfoque muy práctico y para proyectos grandes.
- **Inferencia de Tipos Superior**: `Psalm` es reconocido por su habilidad para "deducir" el tipo de una variable a lo largo de su ciclo de vida, incluso en escenarios complejos sin `type hints` explícitos
- **Auto-Corrección (`--alter`)**: Esta es la característica estrella de `Psalm`. Puede analizar tu código y aplicar correcciones automáticamente, como añadir los `return types` o `param types` que faltan. Es una herramienta increíblemente poderosa para modernizar código legacy.
- **Análisis de Flujo de Manchas (`Taint Analysis`)**: Es una función de seguridad avanzada que rastrea datos de fuentes no confiables (ej. `$_GET`, `$_POST`) y te alerta si esos datos se usan en funciones sensibles (ej. `exec()`, `echo`, consultas SQL) sin haber sido sanitizados.
- **Configuración (`psalm.xml`)**: Utiliza un archivo de configuración en formato XML, a diferencia del formato NEON de `PHPStan`. La configuración inicial es muy sencilla.
- **Niveles de Error (`Error Levels`)**: `Psalm` tiene 8 niveles de error. **Importante**: la escala es inversa a la de `PHPStan`. El `level="1"` es el más estricto, mientras que el `level="8"` es el más permisivo.
- **Línea Base (`Baseline`)**: Al igual que `PHPStan` ([[16.1 PHPStan]]), permite crear un archivo de "`baseline`" para ignorar errores existentes y poder integrar la herramienta en cualquier proyecto sin importar su estado actual.

### Ejemplos Prácticos
##### Instalación e Inicialización
Primero, lo añadimos con `Composer` ([[13.1 Composer]]).
```bash
# Terminal
composer require --dev vimeo/psalm
```
`Psalm` tiene un comando muy útil para generar el archivo de configuración `psalm.xml` por nosotros.
```bash
# Terminal
./vendor/bin/psalm --init
```
Este comando escaneará tu `composer.json`, detectará tus carpetas (`src`, `tests`) y te preguntará a qué nivel de rigurosidad quieres empezar (1-8).
##### El `psalm.xml` básico
El comando anterior genera un archivo como este:
```xml
<?xml version="1.0"?>
<psalm
    errorLevel="2"
    resolveFromConfigFile="true"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="https://getpsalm.org/schema/config"
    xsi:schemaLocation="https://getpsalm.org/schema/config vendor/vimeo/psalm/config.xsd"
>
    <projectFiles>
        <directory name="src" />
        <ignoreFiles>
            <directory name="vendor" />
        </ignoreFiles>
    </projectFiles>
</psalm>
```
- `errorLevel=2`: Un nivel estricto pero razonable para empezar.
- `projectFiles`: Define qué carpetas analizar (`src`) y cuáles ignorar (`vendor`).
##### Código que `Psalm` puede analizar y corregir
Considera esta función simple en un archivo `src/Utils.php`. No tiene tipos declarados
```php
<?php
// src/Utils.php

function calculateTotalPrice($price, $quantity)
{
    if ($price <= 0 || $quantity <= 0) {
        return 0;
    }

    return $price * $quantity;
}
```
##### Ejecutando `Psalm` para encontrar errores
Ejecutamos `Psalm` y nos reportará que faltan tipos.
```bash
# Terminal
./vendor/bin/psalm
```
##### Salida de `Psalm` (ejemplo):
```
ERROR: MissingParamType - src/Utils.php:3:29 - Parameter $price does not have a declared type 
ERROR: MissingParamType - src/Utils.php:3:44 - Parameter $quantity does not have a declared type 
ERROR: MissingReturnType - src/Utils.php:3:1 - Method calculateTotalPrice does not have a return type, expecting float|int
```
##### El poder de la auto-corrección (`--alter`)
Aquí viene la magia. Le pedimos a `Psalm` que arregle los errores por nosotros.
```bash
# Terminal
# We ask Psalm to fix all issues of the type "Missing..."
./vendor/bin/psalm --alter --issues=MissingParamType,MissingReturnType
```
##### Código después de que `Psalm` lo corrigiera:
```php
<?php
// src/Utils.php

function calculateTotalPrice(float|int $price, int $quantity): float|int
{
    if ($price <= 0 || $quantity <= 0) {
        return 0;
    }

    return $price * $quantity;
}
```
`Psalm` analizó el código, infirió los tipos correctos y los añadió por sí mismo!
