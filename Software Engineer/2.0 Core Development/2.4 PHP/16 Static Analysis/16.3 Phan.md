> [!info] Phan (Roadmap SH)
> `Phan` es una herramienta de análisis estático diseñada especialmente para el lenguaje PHP, muy útil para detectar problemas comunes en el código antes de su ejecución. Puede analizar la sintaxis y los comportamientos del código PHP, detectando problemas como variables no declaradas, inconsistentes de tipos, excepciones no detectadas y más. Curiosamente, `Phan` tiene una fortaleza particular: entiende las relaciones entre las diferentes características de PHP, lo que hace que la herramienta sea eficaz para encontrar errores sutiles y complicados. Para usarlo, simplemente instálelo usando `composer` y ejecute el comando `phan` en el directorio de su proyecto.

`Phan` es otro analizador estático para PHP, desarrollado originalmente por Etsy para manejar su masiva base de código. Su principal diferenciador y la razón de su existencia es la velocidad. `Phan` está diseñado para ser extremadamente rápido, lo que logra al depender de una extensión de PHP llamada `php-ast`.

**Analogía**: Si `PHPStan` ([[16.1 PHPStan]]) es el editor de contenido y `Psalm` ([[16.2 Psalm]]) es el editor técnico con superpoderes, `Phan` es el "investigador forense" del equipo editorial. Este investigador no usa los métodos de lectura tradicionales; en su lugar, utiliza un escáner de alta tecnología (la extensión `php-ast`) que digitaliza y procesa el manuscrito completo en segundos. Su especialidad no es tanto reescribir el texto (auto-corrección), sino entregar un informe increíblemente rápido y preciso sobre hechos concretos: qué partes del libro nunca se citan (código muerto), qué personajes se nombren incorrectamente (typos en variables/métodos) y si hay capítulos enteros a los que es imposible llegar (código inalcanzable). Se velocidad le permite ofrecer retroalimentación casi instantánea.

### Conceptos Clave
- **Creado por Etsy**: Su origen en una de las bases de código PHP más grandes del mundo (el monolito de Etsy) explica su obsesión por el rendimiento y la escalabilidad.
- **Dependencia de `php-ast`**: Esta es la característica técnica más importante y distinta de `Phan`.
	- **Qué es?** Es una extensión de PHP que expone el "`Abstract Syntax Tree`" (Árbol de Sintaxis Abstracta) del código. En lugar de analizar el texto, `Phan` analiza esta estructura de datos, lo cual es mucho más rápido.
	- **La consecuencia**: La instalación no es solo un `composer require`. Se necesita instalar y habilitar una extensión en el entorno de PHP, lo que puede ser un paso adicional en Docker o servidores.
- **Velocidad Extrema**: Gracias a `php-ast`, `Phan` puede analizar bases de código enormes significativamente más rápido que sus alternativas basadas en puro PHP.
- **Configuración en PHP**: El archivo de configuración de `Phan` (`.phan/config.php`) es un archivo PHP. Esto ofrece una flexibilidad total, permitiendo usar lógica, `if/else`, `require` y cualquier otra construcción de PHP para definir la configuración.
- **Detección de Código Muerto (`Dead Code`)**: `Phan` es especialmente bueno en encontrar código que nunca se utiliza (clases, métodos o propiedades públicas sin referencia), lo que es invaluable para la limpieza y refactorización de proyectos.
- **Modo Demonio (`Daemon Mode`)**: `Phan` puede ejecutarse como un proceso en segundo plano. En este modo, "observa" los cambios en los archivos y realiza un re-análisis casi instantáneo, lo que lo hace ideal para integraciones con IDEs y obtener feedback en tiempo real al programar.

### Ejemplos Prácticos
##### Prerrequisitos: instalar la extensión `php-ast`
Antes de usar `Phan`, necesitas esta extensión. El método varía según tu sistema.
```bash
# Ejemplo para sistemas que usan PECL (común en entornos de desarrollo)
pecl install ast

# Luego, debes asegurarte de que la extensión esté habilitada en tu php.ini
# Agrega esta línea al final del archivo:
# extension=ast.so
```
**Nota**: Es un entorno con Docker, añadirías el paso de instalación de la extensión en tu `Dockerfile`
##### Instalación de `Phan` con `Composer`
Una vez que `php-ast` está listo, el resto es estándar.
```bash
# Terminal
composer require --dev phan/phan
```
##### Configuración inicial (`.phan/config.php`)
Crea una carpeta `.phan` y dentro un archivo `config.php`.
```php
<?php
// .phan/config.php

/**
 * This configuration file allows you to customize Phan's analysis.
 *
 * @see https://github.com/phan/phan/blob/master/.phan/config.php
 */
return [
    // A list of directories that should be parsed by Phan.
    'directory_list' => [
        'src',
        'vendor/symfony/', // You can even analyze specific vendor folders
    ],

    // A list of directories that should be excluded from analysis.
    'exclude_analysis_directory_list' => [
        'vendor/',
    ],

    // A list of plugins to enable.
    // Phan's functionality is heavily extended by plugins.
    'plugins' => [
        'AlwaysReturnPlugin',
        'UnreachableCodePlugin',
        'DeadCodeDetectionPlugin',
        'UnusedSuppressionPlugin',
    ],
];
```
- `directory_list`: Define qué carpetas analizar.
- `exclude_analysis_directory_list`: Define qué carpetas ignorar en el análisis (pero sí parsear para entender las clases).
- `plugins`: Activa funcionalidades extra. La detección de código muerto, por ejemplo, es un plugin.
##### Código que `Phan` puede analizar
Imagina este servicio en `src/ReportGenerator.php`.
```php
<?php
// src/ReportGenerator.php

class ReportGenerator
{
    /**
     * This method was used in the past, but is no longer called from anywhere.
     */
    public function generateLegacyPdfReport(): bool
    {
        // ... complex logic
        return true;
    }

    public function generateCsvReport(array $data): string
    {
        // Typo here: should be 'implode'
        return implod(',', $data);
    }
}
```
*Problemas que `Phan` encontrará*:
1. El método `generateLegacyPdfReport()` es `public` pero nadie lo está usando (código muerto).
2. Hay un `typo` en la función `implod` (debería ser `implode`).
##### Ejecutando `Phan` y viendo los errores
```bash
# Terminal
./vendor/bin/phan
```
##### Salida de `Phan` (ejemplo):
```
src/ReportGenerator.php:8 PhanUnreferencedPublicMethod Method \ReportGenerator::generateLegacyPdfReport() is public but seems to be unused src/ReportGenerator.php:14 PhanUndeclaredFunction Call to undeclared function \implod(...)
```
