> [!info] cURL (Roadmap SH)
> `cURL` es una forma flexible de realizar soluciones a servidores externos desde un script PHP. `cURL`, que significa URL de cliente, es una biblioteca que facilita varios tipos de métodos de comunicación de red basados en diferentes tipos de URL. Puede, por ejemplo, utilizar funciones `cURL` en PHP para acceder a API REST, descargar archivos o publicar datos de formularios, entre otras cosas.

### Definición
`cURL` es un proyecto de software que proporciona dos cosas:
1. Una herramienta de línea de comandos (`curl`) para transferir datos con URLs.
2. Una librería (`libcurl`) que permite a otros programas, como PHP, usar sus potentes capacidades de transferencias.
En el contexto de PHP, cuando hablamos de `cURL`, nos referimos a la extensión de PHP que actúa como un puente (*o `wrapper`*) para la librería `libcurl`. Esto nos da un control detallados y de bajo nivel para hacer peticiones de red a través de una inmensa cantidad de protocolos (HTTP, HTTPS, FTP, etc.).

**Analogía**: Imagina que `cURL` es el sistema de mensajería universal de internet. No es una aplicación bonita con una interfaz simple, sino la infraestructura subyacente: la oficina de correos, los carteros y los camiones. Te da todas las palancas y botones para enviar cualquier tipo de paquete (datos) al cualquier dirección (URL) del mundo,  usando cualquier método de transporte (protocolo). Puedes especificar el remitente (`headers`), el contenido exacto del paquete (`body`) y cómo quieres recibir la respuesta. Es robusto, fiable y universal, pero requiere que conozcas el proceso paso a paso.

### Conceptos Clave
- **Herramienta vs. Librería**: Es crucial entender que `curl` en tu terminal es diferente a la extensión `cURL` de PHP. La extensión usa `libcurl`, la misma librería que usa la herramienta de terminal pero a través de funciones PHP.
- **El Flujo de Trabajo en PHP**: Realizar una petición con `cURL` en PHP sigue un patrón de 4 pasos muy definido y fundamental:
	1. **Inicializar (`curl_init`):** Se crea un "`handle`" de `cURL`, que es como abrir una nueva sesión de mensajería.
	2. **Configurar opciones (`curl_setopt`)**: Este es el paso más importante. Se configuran todos los detalles de la petición: la URL, el método (`GET`, `POST`) ([[8.1 HTTP Methods]]), los `headers` ([[1.06 HTTP Headers]]), el cuerpo de petición, etc.
	3. **Ejecutar (`curl_exec`)**: Se realiza la petición de red. El cartero sale a entregar el paquete.
	4. **Cerrar (`curl_close`)**: Se libera el manejador y se cierran todos los recursos asociados a él.
- `CURLOPT_RETURNTRANSFER`: Esta es la opción más importante que debes recordar. Por defecto `curl_exec` imprime el resultado de la petición directamente en la salida. Al establecer `CURLOPT_RETURNTRANFER` en `true`, le dices a `cURL` que te devuelva el resultado como un `string`, para que puedas guardarlo en una variable y procesarlo (ej. decodificar un JSON).
- **Manejo de errores y metadatos**:
	- `curl_error()`: Devuelve un `string` con el errores si la petición falló a nivel de red (ej. no se pudo conectar al host).
	- `curl_getinfo()`: Devuelve un array con toda la información de la transferencia, como el código de estado HTTP (`http_code`), que es vital para saber si la petición fue exitosa (ej. 200 OK) o si hubo un error (ej. 404 `Not Found`, 500 `Internal Server Error`) [[1.05 HTTP Status Codes]].

### Ejemplos Prácticos
##### Petición `GET` simple (consultar una API pública)
Este es el caso de uso más común: obtener datos de una API.
```php
<?php
// The target API endpoint
$url = 'https://jsonplaceholder.typicode.com/posts/1';

// 1. Initialize cURL session
$ch = curl_init();

// 2. Set options
// Set the URL
curl_setopt($ch, CURLOPT_URL, $url);
// IMPORTANT: Set this to true to get the response as a string
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

// 3. Execute the request
$response = curl_exec($ch);

// Check for errors and get HTTP status code
if (curl_errno($ch)) {
    echo 'cURL Error: ' . curl_error($ch);
} else {
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    if ($httpCode === 200) {
        $data = json_decode($response, true);
        echo "Post Title: " . $data['title'];
    } else {
        echo "API returned HTTP status code: " . $httpCode;
    }
}

// 4. Close the cURL session
curl_close($ch);
```
##### Petición `POST` con JSON (Enviar datos a una API)
Crear un nuevo recurso enviando datos en formato JSON
```php
<?php
$url = 'https://jsonplaceholder.typicode.com/posts';
$postData = [
    'title' => 'My new post',
    'body' => 'This is the content of my awesome new post.',
    'userId' => 10,
];
$jsonPayload = json_encode($postData);

$ch = curl_init();

curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

// Specify that this is a POST request
curl_setopt($ch, CURLOPT_POST, true);
// Attach the JSON payload
curl_setopt($ch, CURLOPT_POSTFIELDS, $jsonPayload);
// Set the content-type to application/json
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
    'Content-Length: ' . strlen($jsonPayload)
]);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

// HTTP 201 Created is the typical success code for POST
if ($httpCode === 201) {
    echo "Post created successfully!\n";
    print_r(json_decode($response, true));
} else {
    echo "Failed to create post. HTTP Code: " . $httpCode;
}
```
##### Petición con `Header` de Autenticación
Muchas APIs requieren un token de autenticación (`API Key`, `Bearer Token`) en los `headers`.
```php
<?php
$url = 'https://api.example.com/v1/me'; // A protected endpoint
$apiKey = 'your_secret_api_key_here';

$ch = curl_init();

curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

// Add the Authorization header
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Authorization: Bearer ' . $apiKey,
    'Content-Type: application/json'
]);

$response = curl_exec($ch);
// ... continue with error checking and processing
curl_close($ch);

echo $response;
```
