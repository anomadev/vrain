> [!info] Caching Strategies (Roadmap SH)
> La estrategias de almacenamiento de caché son fundamentales para la optimización del rendimiento en PHP. El almacenamiento en caché minimiza la carga del servidor y mejora la velocidad de la aplicación al almacenar temporalmente los resultados de operaciones costosas para que puedan reutilizarse en solicitudes posteriores. Algunas técnicas de almacenamiento en caché utilizadas en PHP incluyen el almacenamiento en caché de código de operación, el almacenamiento en caché de objetos, el almacenamiento en caché de consultas de base de datos o el almacenamiento de caché de página completa. Por ejemplo, `OPcache` es un sistema de almacenamiento en caché de códigos de operación que mejora el rendimiento de PHP al almacenar el código de bytes de scripts precompilados en la memoria, eliminando la necesidad de que PHP cargue y analice scripts en cada solicitud.

### Definición
`OPcache` es una extensión de caching integrada en el núcleo de PHP. Su única función es mejorar el rendimiento almacenando el `bytecode` precompilado de los scripts PHP en la memoria compartida, evitando así la necesidad de cargar y compilar los scripts en cada petición.
El flujo normal sin `OPcache` es: Petición -> Leer archivo `.php` -> Analizar y compilar a `opcode` -> Ejecutar. `OPcache` interviene después de la compilación, guardando ese "`opcode`" para que las peticiones futuras puedan saltarse los primeros pasos.

**Analogía**: Imagina que eres un chef que cocina una receta completa de un libro (un script PHP).
- **Sin `OPcache`**: Cada vez que un cliente pide ese platillo, tienes que abrir el libro, leer la receta desde el principio, interpretar cada paso y luego cocinar. Es lento y repetitivo.
- **Con `OPcache`**: La primera vez que preparas el platillo, memorizas la receta y dejas todos los ingrediente ya medidos y listos en la encimera (el `opcode` en la memoria compartida). A partir de la segunda petición, ya no necesitas el libro; vas directamente a los ingredientes pre-listos y cocinas. El resultado es un platillo servido de forma drásticamente más rápida.

### Conceptos Clave
- **`Caching` de `Opcode`**: Es vital entender que `OPcache` no guarda el resultado de una función ni una consulta de base de datos. Guarda la versión compilada del código PHP, eliminando la sobrecarga de lectura de disco y compilación.
- **Integrado en PHP**: Desde PHP 5.5 ([[1.1 What is PHP]]), `OPcache` viene incluido y es el estándar de facto. No es necesario instalar una librería externa, solo asegurarse de que la extensión esté habilitada en `php.ini` ([[20.4 Configuration Files]]).
- **Memoria Compartida (`Shared Memory`)**: El `bytecode` compilado se almacena en un segmento de memoria que es compartido por todos los procesos PHP (ej. los `workers` de `PHP-FPM` [[19.6 PHP-FPM]]), maximizando la eficiencia.
- **Configuración en `php.ini`** ([[20.4 Configuration Files]]): El comportamiento de `OPcache` se controla exclusivamente a través de directivas en el archivo `php.ini`. Las más importantes son:
	- `opcache.enable`: `1` para habilitarlo, `0` para deshabilitarlo.
	- `opcache.memory_consumption`: La cantidad de RAM (en MB) que le asignas a `OPcache` para guardar los scripts.
	- `opcache.revalidate_freq`: La frecuencia (en segundos) con la que PHP revisará si el archivo original ha cambiado. En producción se suele poner en `0` para un rendimiento máximo.
	- `opcache.validate_timestamps`: Si está en `0` (con `revalidate_freq=0`), PHP nunca revisará si el archivo cambió, requiriendo un reinicio de `PHP-FPM` para ver los cambios. Es la configuración más rápida para producción.
- `Preloading` (Precarga): Una características avanzada (desde PHP 7.4 - [[1.1 What is PHP]]) que permite indicarle a `OPcache` que compile y cargue un conjunto específico de archivos en la memoria durante el arranque del servidor, antes de que llegue ninguna petición, manteniéndolos permanentemente disponibles.

### Ejemplos Prácticos
##### Configuración Típica para Producción (`php.ini`)
En producción, el objetico es el máximo rendimiento. El código no cambia, por lo que podemos desactivar las comprobaciones de archivos.
```ini,toml
; php.ini - Production Settings

; Enable OPcache
opcache.enable=1

; Allocate 128MB of memory for the cache. Adjust based on your app's size.
opcache.memory_consumption=128

; Set max number of files to be cached. Must be a prime number.
opcache.max_accelerated_files=10007

; IMPORTANT: Tells OPcache to check for file updates based on revalidate_freq.
opcache.validate_timestamps=1

; How often (in seconds) to check for file updates.
; Set to 0 to only check for updates on server restart for max performance.
opcache.revalidate_freq=0
```
**Nota Clave**: Con `revalidate_freq=0`, debes reiniciar el servicio `php-fpm` cada vez que haces un despliegue para que los cambios en tu código se reflejen.
##### Configuración Típica para Desarrollo (`php.ini`)
En desarrollo, el objetivo es ver los cambios inmediatamente. Sacrificamos rendimiento por conveniencia.
```ini,toml
; php.ini - Development Settings

; Enable OPcache
opcache.enable=1

; Keep memory consumption low, as it's just for one developer
opcache.memory_consumption=64

; Check for file updates on every single request.
opcache.validate_timestamps=1
opcache.revalidate_freq=0 
; When validate_timestamps is 1, a freq of 0 means check every time.
```
