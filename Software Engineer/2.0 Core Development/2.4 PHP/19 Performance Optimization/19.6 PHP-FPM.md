> [!info] PHP-FPM (Roadmap SH)
> `PHP-FPM` o `PHP FastCGI Process Manager`, es una forma robusta y eficiente de servir aplicaciones PHP. Mejora drásticamente la velocidad y la eficiencia de procesamiento de las aplicaciones PHP al aislar cada solicitud, evitando así que los trabajos interfieran entre sí. Con `PHP-FPM`, su servidor puede gestionar más visitantes simultáneos sin ralentizaciones.

### Definición
`PHP-FPM (FastCGI Process Manager)` es un gestor de procesos de alto rendimiento para PHP que implementa la interfaz `FastCGI`. Su función principal es gestionar un conjunto (o `pool`) de procesos de PHP que están listos para recibir y ejecutar peticiones web. Actúa como un intermediario entre el servidor web (como `Nginx` ([[22.2 Nginx]]) o `Apache` ([[22.1 Apache]])) y el motor de PHP.
En lugar de que el servidor web tenga que iniciar un nuevo proceso de PHP para cada petición (lo cual es lento), `PHP-FPM` mantiene procesos "calientes" y listos para trabajar, distribuyendo las peticiones entrantes entre ellos.

**Analogía**: Imagina que tu sitio web es un restaurante de comida rápida muy popular.
- El servidor web (`nginx`) es el cajero que toma los pedidos de los clientes.
- `PHP-FPM` es el gerente de cocina.
- Los procesos `workers` de PHP son los cocineros.
El gerente (`PHP-FPM`) no espera a que llegue un pedido para contratar un cocinero. El ya tiene un equipo de cocineros (un `pool`de `workers`) listos en la cocina. cuando el cajero le pasa un pedido, el gerente se lo da a un cocinero que esté libre. Si hay una oleada de pedidos, el gerente puede llamar a más cocineros que tiene en espera, hasta un límite máximo para no colapsar la cocina. Este sistema es increíblemente eficiente.

### Conceptos Clave
- **Separación de Responsabilidades**: `PHP-FPM` permite que el servidor web se especialice en manejar conexiones de red y servir archivos estáticos, mientras que el `pool` de `PHP-FPM` se especializa exclusivamente en ejecutar código PHP. Esta separación es clave para el rendimiento y la escalabilidad.
- **Pools de Procesos**: La configuración principal de FPM se basa en "`pools`". Puedes tener múltiples pools, cada uno con su propia configuración (ej. `www.conf`, `api.conf`). Esto es muy útil para aislar diferentes sitios web en un mismo servidor, cada uno ejecutándose con su propio usuario y límites de recursos.
- **Gestor de Procesos (`pm`)**: Esta es la directiva más importante para el ajuste de rendimiento. Define cómo FPM gestiona el número de procesos hijos (cocineros). Tiene tres modos:
	- `static`: Mantiene un número fijo de procesos (`pm.max_children`). Ideal para servidores con mucha memoria y tráfico constante, ya que no hay sobrecarga al crear/destruir procesos.
	- `dynamic`: El modo más común. Mantiene un número variable de procesos entre un mínimo y un máximo, basándose en la carga. Es flexible y equilibra el uso de memoria y la capacidad de respuesta.
	- `ondemand`: No mantiene procesos en espera. Los crea "bajo demanda" cuando llega una petición. Es ideal para sitios de muy bajo tráfico o para entornos de desarrollo, ya que ahorra memoria cuando está inactivo.
- **Directivas Clave para `pm = dynamic`**:
	- `pm.max_children`: El número máximo de procesos hijos que se pueden crear. Es el límite absoluto para evitar sobrecargar el servidor.
	- `pm.start_servers`: El número de procesos que se inician cuando FPM arranca.
	- `pm.min_spare_servers`: El número mínimo de procesos "libres" que FPM intentará mantener. Si hay menos, creará nuevos.
	- `pm.max_spare_servers`: El número máximo de procesos "libres". si hay más, FPM eliminará algunos.
- **Reciclaje de Procesos (`pm.max_request`)**: Esta directiva le dice a FPM que reinicie un proceso hijo después de que haya manejado un número `X` de peticiones. Es una medida de seguridad crucial para mitigar fugas de memoria (`memory leaks`) en código PHP mal escrito.

### Ejemplos Prácticos
##### Ubicación del archivo de configuración
La configuración de los `pools` de FPM se encuentra típicamente en un directorio específico. La ruta común en sistemas Linux es:
```
/etc/php/{version}/fpm/pool.d/www.conf
```
(Reemplaza `{version}` con tu versión de PHP, ej. `8.2` - [[1.1 What is PHP]]).
##### Ejemplo de configuración de un `pool` dinámico (`www.conf`)
Este es un ejemplo comendo de una configuración balanceada para un servidor web de tamaño mediano.
```ini,toml
; www.conf - Example Dynamic Pool Configuration

[www]

; Run this pool as the 'www-data' user and group
user = www-data
group = www-data

; Listen for connections on a Unix socket for better performance than TCP/IP
listen = /run/php/php8.2-fpm.sock
listen.owner = www-data
listen.group = www-data

; --- Process Manager Configuration ---
; Use the dynamic process manager
pm = dynamic

; The absolute maximum number of concurrent requests your server can handle.
; Calculation depends on RAM. (Total RAM - System RAM) / Avg. Process Size = max_children
pm.max_children = 50

; Number of children to start when FPM is initiated
pm.start_servers = 10

; Minimum number of idle/"spare" server processes
pm.min_spare_servers = 5

; Maximum number of idle/"spare" server processes
pm.max_spare_servers = 20

; Recycle a child process after it has handled 500 requests.
; This is a safeguard against memory leaks.
pm.max_requests = 500
```
**Nota**: El cálculo de `pm.max_children` es la parte más crítica del `tuning`. Un valor demasiado alto puede agotar la RAM y hacer que el servidor colapse. Un valor demasiado bajo puede subutilizar el servidor y crear colas de peticiones.