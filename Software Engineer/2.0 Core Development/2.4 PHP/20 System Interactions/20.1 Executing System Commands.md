> [!info] Executing System Commands (Roadmap SH)
> PHP proporciona a los desarrolladores la flexibilidad de invocar comandos del sistema directamente desde scripts PHP. Esto se puede lograr con funciones como `exec()`, `system()`, o `passthru()`, que permiten que su script PHP ejecute instrucciones a nivel del sistema e interactúe con el servidor subyacente. Esto puede ser útil en varios escenarios: para automatizar tareas, orquestar actividades del sistema o incluso para extraer información del sistema. Sin embargo, es importante utilizar estas funciones con precaución debido a los riesgos de seguridad que supones ejecutar comandos del sistema.

### Definición
La ejecución de comandos del sistema en PHP se refiere a la capacidad que tiene un script para ejecutar programas, comandos o scripts directamente en la línea de comandos del sistema operativo del servidor. Estas funciones actúan como un paquete entre tu aplicación PHP y el `shell` del servidor (como `Bash` en Linux o `CMD` en Windows).
Si bien es una capacidad extremadamente potente para interactuar con otras herramientas, también es una de las mayores superficies de ataque si no se maneja con un cuidado y una seguridad extremos.

**Analogía**: Darle a PHP la capacidad de ejecutar comandos del sistema es como darle al recepcionista de tu empresa (`tu script PHP`) un micrófono conecto al sistema de altavoces de todo el edificio (`el shell del servidor`). Puede usarlo para anuncios útiles para que lea un mensaje malicioso ("Evacúen el edificio, hay un incendio!"), el resultado puede ser el caos. La clave es nunca, bajo ninguna circunstancia, dejar que el extraño hable directamente al micrófono.

### Conceptos Clave
- **El peligro: Inyección de Comandos (`Command Injection`)**: Esta es la vulnerabilidad de seguridad `#1` asociada a este tema. Ocurre cuando se utiliza la entrada de un usuario (o cualquier dato no confiable) directamente en un comando del sistema. Un atacante puede "inyectar" comandos adicionales para que sean ejecutados por el servidor.
- **Las funciones de sanitización** ([[9.7 Sanitization Techniques]]): Son tu defensa más importante. NUNCA debes usar datos de usuario en un comando sin antes pasarlos por una de estas funciones.
	- `escapeshellarg()`: Trata toda la cadena como un único argumento seguro. Envuelve la cadena entre comillas y escapa cualquier comilla interna. Es la opción más segura y recomendada en la mayoría de los casos.
	- `escapeshellcmd()`: Escapa cualquier carácter en una cadena que pueda ser usado para terminar un comando y ejecutar otro (como `;`, `&`, `|`). Es menos seguro que el anterior porque aún permite que la cadena sea interpretada por el `shell`.
- **Las funciones principales de ejecución**:
	- `shell_exec()`  (y su operador ` `` `): Ejecuta un comando y devuelve la salida completa como una cadena. Es útil cuando necesitas capturar todo el resultado en una variable.
	- `exec()`: Ejecuta un comando, pero solo devuelve la última línea de la salida. Es útil para obtener un resultado simple o un estado. También puede devolver el código de salida de la ejecución.
	- `system()`: Ejecuta el comando y muestra la salida directamente en el navegador o la terminal. Intenta vaciar el buffer del servidor web después de cada línea.
	- `passthru`: Similar a `system()`, pero se usa cuando se espera una salida binaria (como una imagen), ya que pasa los datos en crudo sin ninguna modificación.
- **Restricciones de Seguridad (`php.ini`)**: Por seguridad, muchos entornos de hosting compartido y configuraciones de producción restringen estas funciones usando la directiva `disable_functions` en `php.ini` ([[20.4 Configuration Files]]).

### Ejemplos Prácticos
##### Ejemplo seguro y simple
Obtener el hash del último `commit` de un repositorio Git. No hay entrada de usuario, por lo que es seguro.
```php
<?php
// Get the short hash of the latest git commit
$commitHash = shell_exec('git rev-parse --short HEAD');

// trim() is used to remove any trailing newline characters
echo "Current version: " . trim($commitHash);
```
##### Ejemplo peligroso! (Vulnerable a inyección de comandos)
Este código intenta obtener el tamaño de un archivo proporcionado por el usuario.
```php
<?php
// DANGEROUS CODE - DO NOT USE
// An attacker can craft a malicious filename.
// Example URL: /script.php?filename=nonexistent;%20ls%20-la

$filename = $_GET['filename'];

// The user input is passed directly to the command
$output = shell_exec('ls -lh ' . $filename);

echo "<pre>$output</pre>";

// The executed command becomes: 'ls -lh nonexistent; ls -la'
// PHP executes BOTH commands, listing the directory content.
```
Un atacante podría usar `filename=something; rm -rf /` con consecuencias catastróficas.
##### El mismo ejemplo, pero seguro
Usando `escapeshellarg()` para sanitizar la entrada del usuario.
```php
<?php
// SECURE CODE
// Example URL: /script.php?filename=nonexistent;%20ls%20-la

$filename = $_GET['filename'];

// The user input is now treated as a single, safe argument.
$safeFilename = escapeshellarg($filename);
$output = shell_exec('ls -lh ' . $safeFilename);

echo "<pre>$output</pre>";

// The executed command becomes: 'ls -lh \'nonexistent; ls -la\''
// The shell now looks for a single file named 'nonexistent; ls -la'
// and safely reports that it does not exist. No command injection occurs.
```
