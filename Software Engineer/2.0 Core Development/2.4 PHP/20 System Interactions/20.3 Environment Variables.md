> [!info]  Environment Variables (Roadmap SH)
> Las variables de entorno proporcionan una manera de influir en el comportamiento del software en su sistema. Consisten en pares nombre/valor y se utilizan para diversos propósitos, como por ejemplo para rutas de directorio, nombres de usuario o contraseñas que su aplicación PHP podría utilizar. Puede configurar variables de entorno PHP utilizando la función `putenv()` y recuperarlas utilizando `getenv()`.

### Definición
Las variables de entorno son un conjunto de pares clave-valor que existen fuera del código de tu aplicación, dentro del entorno del sistema operativo donde se ejecuta el script. Su propósito principal es externalizar la configuración, permitiendo que una misma base de código se comporte de manera diferente en distintos entornos (desarrollo, pruebas, producción) sin modificar una sola línea de código.
Esto es crucial para la seguridad (al no guardar secretos como contraseñas en el código) y para la portabilidad de la aplicación.

**Analogía**: Imagina que tu aplicación es un dispositivo electrónico universal, como un cargador de laptop.
- El código es el cargador en sí mismo, que siempre funciona igual.
- Las variables de entorno son los diferentes adaptadores de enchufe que le pones para que funcione en distintos países (entornos).
No incrustas un enchufe europeo directamente en el cargador; eso lo haría inútil en América. En su lugar, el cargador tiene un puerto estándar, y tú le conectas el adaptador que necesitas. De la misma manera, tu código lee `DB_HOST`, y el entorno le proporciona el valor correcto, ya sea `localhost` en desarrollo o `rds.amazonaws.com` en producción.

### Conceptos Clave
- **Separación de configuración y código**: Este es el principio fundamental, popularizado por le metodología `Twelve-Factor App`. La configuración que varía entre entornos (credenciales, hosts de servicios, claves de API) debe estar en el entorno, no en el código.
- **Cómo leer variables en PHP**:
	- `getenv('VAR_NAME')`: La función directa y universal para obtener el valor de una variable de entorno. Devuelve `false` si no existe.
	- `$_ENV['VAR_NAME']`: Un `array superglobal` ([[8.2 Super Global Variables]]) que contiene las mismas variables. Su disponibilidad depende de la directiva `variables_order` en `php.ini` ([[20.4 Configuration Files]]).
	- `$_SERVER['VAR_NAME']`: A menudo, las variables de entorno también se cargan en este `array superglobal`.
- **Cómo establecer variables (la forma correcta)**: Las variables de entorno se deben definir fuera de PHP, a nivel de servidor o sistema.
	- Servidor Web: En `Nginx` ([[22.2 Nginx]]) con FPM ([[19.6 PHP-FPM]]) se usa `fastcgi_param`, en Apache `SetEnv`.
	- Docker: Es un `dockerfile` o `docker-compose.yml` usando la directiva `environment`.
	- Sistema Operativo: Exportándolas en el `shell` (`export DB_USER=...`) o en scripts de arranque.
	- Hosting / PaaS: A través de un panel de control web (común en `Heroku`, `Vercel`, etc.).
- **Archivos `.env`**: Para el desarrollo local, es estándar de facto es usar un archivo de texto llamado `.env` en la raíz del proyecto. Este archivo nunca debe ser subido a Git. Una librería como `vlucas/phpdotenv` se encarga de leer este archivo al iniciar la aplicación y cargar sus valores en el entorno de PHP.
- **`putenv()` (Uso limitado)**: La función `putenv()` puede establecer una variable de entorno, para su alcance esta limitado al proceso actual. No es la forma recomendada para configurar una aplicación web, ya que el cambio no es persistente y puede no ser seguro en todos los SAPI.

### Ejemplos Prácticos
##### Lectura de variables para configurar una BBDD
Un archivo de configuración de base de datos que es seguro y portable.
```php
<?php
// config/database.php

return [
    'host' => getenv('DB_HOST'),
    'port' => getenv('DB_PORT'),
    'database' => getenv('DB_DATABASE'),
    'username' => getenv('DB_USERNAME'),
    'password' => getenv('DB_PASSWORD'), // Secret is read from the environment
];
```
##### Archivo `.env` para desarrollo local
Simple, legible y nunca se sube al repositorio
```
# .env file at the project root 
DB_HOST=127.0.0.1 
DB_PORT=3306 
DB_DATABASE=my_local_db 
DB_USERNAME=root 
DB_PASSWORD="password123" 

STRIPE_API_KEY="pk_test_123abc..."
```
##### Cargar el archivo `.env` con una librería
En el punto de entrada de tu aplicación (ej. `index.php` o un script de `bootstrap`), usas una librería para cargar las variables del `.env`.
```php
<?php
// bootstrap.php

require 'vendor/autoload.php';

// This library reads the .env file and loads its content into the environment
// so getenv() and $_ENV can access them.
$dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/../');
$dotenv->load();

// Now the rest of the application can use getenv()
// ...
```
