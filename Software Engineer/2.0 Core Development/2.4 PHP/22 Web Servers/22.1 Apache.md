> [!info] Apache (Roadmap SH)
> Apache es un servidor web popular que puede alojar aplicaciones PHP de forma eficiente. Se integra perfectamente con PHP de forma eficiente. Se integra perfectamente con PHP mediante su módulo `mod_php`, lo que proporciona un entorno estable y consistente para la ejecución de scripts PHP. Esta compatibilidad crea una experiencia de usuario perfecta, ya que las páginas PHP se sirven como si fueran parte del sitio web y no simplemente archivos que se ejecutan en el servidor.

### Definición
El servidor HTTP Apache (comúnmente llamado Apache) es un servidor web de código abierto, multiplataforma y no de los más antiguos y utilizados en la historia de internet. Su función principal es recibir peticiones HTTP de los navegadores y servirles el contenido solicitado, ya sean archivos estáticos (HTML, CSS, imágenes) o contenido dinámico procesado por otros programas, como PHP.
La forma tradicional y más conocida de integrar PHP con Apache es a través de un módulo llamado `mod_php`, que incrusta el intérprete de PHP directamente dentro de los procesos de Apache.

**Analogía**: Si tu sitio web es un gran restaurante, el servidor Apache es el edificio entero y su personal. Apache se encarga de recibir a los clientes en la puerta, sentarlos, tomarles la orden y servirles platos sencillos directamente (archivos estáticos). Si el cliente pide un platillo complejo que requiere una preparación especial (un script PHP), con `mod_php`, cada mesero tiene un pequeño chef en su mochila. El mesero-chef puede preparar el platillo ahí mismo y servirlo. Es un sistema muy integrado, pero significa que todo el personal debe cargar con el equipo de cocina, lo usen o no.

### Conceptos Clave
- `mod_php`: Es la forma clásica de ejecutar PHP con Apache. Carga el intérprete de PHP como parte del propio servidor.
	- Ventaja: Configuración muy simple y puede ser muy rápido para peticiones individuales, ya que no hay comunicación externa entre procesos.
	- Desventajas: Menos flexible y consume más memoria, ya que cada proceso de Apache carga el intérprete de PHP completo, incluso si solo está sirviendo una imagen. Además, el ciclo de vida de PHP está atado al de Apache.
- **`MPMs (Multi-Processing Modules)`**: Apache es modular y su manejo de peticiones se define por un `MPM`. Los más relevantes son:
	- `prefork`: El modelo clásico. Crea un nuevo proceso por cada petición, No usa hilos (`threads`), lo que lo hacía seguro para usar con `mod_php`, que históricamente no era `thread-safe`. Consume más memoria.
	- `event` (y `worker`): Modelos modernos que usan hilos para manejar múltiples conexiones por proceso. Son mucho más eficientes en memoria y escalan mejor con alta concurrencia. `event` es el preferido hoy en día.
- **Archivos `.htaccess`**: Esta es una de la características más famosas y potentes de Apache. Son archivos de configuración que se pueden colocar en cualquier directo para sobrescribir la directivas del servidor para ese directorio específico y sus subdirectorios. Permiten a los desarrolladores controlar redirecciones, reescritura de URLs y reglas de acceso sin necesidad de reiniciar el servidor.
- **Alternativa Moderna: `PHP-FPM`** ([[19.6 PHP-FPM]]): Al igual que `Nginx` ([[22.2 Nginx]]), Apache también puede ser configurado para comunicarse con `PHP-FPM`. En esta configuración, Apache actúa como un "proxy reverso", pasando las peticiones de PHP a FPM. Este es el método preferido para sitios de alto rendimiento, ya que se desacopla PHP de Apache y permite usar `MPM`s más eficientes como `event`.

### Ejemplos Prácticos
##### Configuración básica de un `VirtualHost` con `mod_php`
Este es el bloque de configuración fundamental en Apache para definir un sitio web.
```xml
# /etc/apache2/sites-available/your-domain.com.conf

<VirtualHost *:80>
    ServerAdmin webmaster@your-domain.com
    ServerName your-domain.com
    ServerAlias www.your-domain.com

    DocumentRoot /var/www/your-domain.com/public

    # Define settings for the document root directory
    <Directory /var/www/your-domain.com/public>
        Options Indexes FollowSymLinks
        AllowOverride All  # This allows .htaccess files to work
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```
##### Ejemplo común de `.htaccess` (`FrontController`)
Esta archivo, colocado en el `DocumentRoot`, es usado por casi todos los `frameworks` modernos para dirigir todas las peticiones a un único punto de entrada (`index.php`), a menos que la petición sea para un archivo o directorio que realmente existe.
```xml
# .htaccess file in the /public directory

<IfModule mod_rewrite.c>
    RewriteEngine On

    # If the request is for a file that actually exists, serve it directly
    RewriteCond %{REQUEST_FILENAME} !-f
    # If the request is for a directory that actually exists, serve it directly
    RewriteCond %{REQUEST_FILENAME} !-d

    # Otherwise, rewrite the request to index.php
    RewriteRule . index.php [L]
</IfModule>
```
