`ALTER TABLE` es una sentencia DDL que permite modificar la estructura de una tabla existente sin tener que recrearla. Con `ALTER TABLE`, puedes:
- Agregar, modificar o eliminar columnas
- Cambiar el tipo de dato de una columna
- Agregar o quitar restricciones (`constraints`), como claves primarias, foráneas, `UNIQUE`, `NOT NULL`, o `CHECK`.
- Renombrar la tabla o sus columnas
- Agregar o eliminar índice (según el motor)

> Analogía: Imagina que una tabla es una habitación ya construida 
> `ALTER TABLE` es como hacer mejoras en esa habitación: poner una ventana nueva (nueva columna), quitar una pared divisoria (eliminar columnas), cambiar el tipo de piso (modificar tipo de dato), o renombrar la habitación (Sala de reuniones antes era Oficina pequeña).

---
### Conceptos Clave
##### Agregar Columnas
```sql
-- Agregar columnas
ALTER TABLE nombre_tabla
ADD COLUMN nueva_columna TIPO [CONSTRAITS];
```
- Ejemplo: agregar `fecha_nacimiento` a una tabla de usuarios
- Se puede agregar más de una columna en una sola sentencia (algunos motores permiten separar con comas).
##### Eliminar Columnas
```sql
-- Eliminar columnas
ALTER TABLE nombre_tabla
DROP COLUMN columna_existente;
```
- Eliminar una columna descarta TODO el contenido de esa columna para todas las filas. Algunos motores como MySQL pueden requerir `DROP COLUMN` explícito para cada columna.
##### Modificar tipo de dato
```sql
-- Modificar tipo de dato
-- Sintaxis (PostgreSQL)
ALTER TABLE nombre_tabla
ALTER COLUMN columna TYPE NUEVO_TIPO [USING expresion];
```

```sql
-- Modificar tipo de dato
-- Sintaxis (MySQL)
ALTER TABLE nombre_table
MODIFY COLUMN column NUEVO_TIPO;
```
- El proceso puede bloquear la tabla para reescribirla. Algunos motores permiten conversiones implícitas; otros requieren convertir explícitamente con `USING`.
##### Renombrar columna
```sql
-- Sintaxis PostgreSQL
ALTER TABLE nombre_tabla
RENAME COLUMN columna_actual TO nueva_columna
```

```sql
-- Sintaxis MySQL
ALTER TABLE nombre_tabla
CHANGE COLUMN columna_actual nueva_columna TIPO;
```
- En SQL Server también existe `sp_rename`, pero en la mayoría de SQL estándar se usa `RENAME COLUMN`.
##### Renombrar tabla
```sql
ALTER TABLE nombre_antiguo
RENAME to nombre_nuevo
```
##### Agregar o quitar restricciones (`constraints`)
Agregar clave primaria (si la tabla no la tenía):
```sql
ALTER TABLE nombre_tabla
ADD PRIMARY KEY (column_pk);
```
Quitar clave primaria (PostgreSQL):
```sql
ALTER TABLE nombre_tabla
DROP CONSTRAINT nombre_constraint_pk;
```
Agregar llave foránea:
```sql
ALTER TABLE nombre_tabla
	ADD CONSTRAINT fk_nombre
	FOREIGN KEY (columna_fk)
	REFERENCES otra_tabla(columna_pk)
	ON DELETE CASCADE;
```
Quitar llave foránea:
```sql
ALTER TABLE nombre_tabla
DROP CONSTRAINT fk_nombre;
```
Agregar o quitar `NOT NULL` (PostgreSQL):
```sql
ALTER TABLE nombre_tabla
	ALTER COLUMN columna SET NOT NULL;

ALTER TABLE nombre_tabla
	ALTER COLUMN columna DROP NOT NULL;
```
En MySQL, para quitar `NOT NULL`, se hace `MODIFY COLUMN columna TIPO NULL`.
##### Agregar o eliminar índices
No todos los motores permiten manejar índices desde `ALTER TABLE`
```sql
-- PostgreSQL
CREATE INDEX idx_nombre ON nombre_tabla (columna);
DROP INDEX idx_nombre;
```

```sql
-- MySQL
ALTER TABLE nombre_tabla
	ADD INDEX idx_nombre (columna);

ALTER TABLE nombre_tabla
	DROP INDEX idx_nombre;
```
##### Operaciones múltiples
En PostgreSQL, varias operaciones se pueden encadenar:
```sql
ALTER TABLE nombre_tabla
	ADD COLUMN col1 TIPO,
	DROP COLUMN col2,
	RENAME COLUMN col3 TO col_nuevo
	ALTER COLUMN col4 SET NOT NULL;
```
En MySQL, deber ir en sentencias separadas (excepto para `ADD COLUMN` múltiples en la misma instrucción).
##### Bloqueos y riesgos
- `ALTER TABLE` puede bloquear la tabla completa o hacer un `rewrite`, lo cual impacta rendimiento en tablas grandes.
- Recomendada planificación en ventana de baja demanda si la tabla es muy grande.
- Algunas operaciones (por ejemplo, cambiar tipo de dato) puede requerir copiar toda la tabla

---
### Ejemplos Prácticos
##### Agregar una columna `stock` para controlar inventario
```sql
ALTER TABLE productos
  ADD COLUMN stock INT DEFAULT 0;
```
- Añade la columna `stock` de tipo entero con valor por defecto 0 en cada fila (para que no sea nulo en registros existentes).
- Perfecto para llevar inventario sin recrear la tabla.
##### Eliminar la columna `decripcion_corta` porque ya no se usa
```sql
ALTER TABLE productos
  DROP COLUMN descripcion_corta;
```
- Borra la columna `descripcion_corta` y su contenido para todas las filas
- Útil cuando una columna queda obsoleta y ocupa espacio innecesario
##### Cambiar el tipo de dato de `precio` de `DECIMAL(8,2)` a `DECIMAL(10, 2)` para precios más altos
```sql
ALTER TABLE productos
  ALTER COLUMN precio TYPE DECIMAL(10,2);
```
- Ajusta la precisión de la columna `precio` para permitir valores de hasta dígitos enteros y 2 decimales.
- Puede tardar en tablas con muchas filas, pues debe reescribir datos.
##### Renombrar la columna `nombre` a `nombre_producto`
```sql
ALTER TABLE productos
  RENAME COLUMN nombre TO nombre_producto;
```
- Cambia el nombre de la columna para mayor claridad, sin perder datos.
- Cualquier consulta anterior que use `nombre` fallará, por lo que hay que actualizar código.
##### Renombrar la tabla `productos` a `inventario`
```sql
ALTER TABLE productos
  RENAME TO inventario;
```
- Cambia el nombre de la tabla entera
- Cualquier referencia a `producto` en vistas, funciones o `queries` previas dejará de funcionar y deberá actualizarse.
###### Agregar una restricción `UNIQUE` a la columna `sku` (`Stock Keeping Unit`)
```sql
ALTER TABLE inventario
  ADD CONSTRAINT uq_sku UNIQUE (sku);
```
- Impide que dos productos tengan el mismo `sku`
- Si ya existieran duplicados, el comando fallaría hasta que se limpien datos duplicados
##### Agregar una clave foránea: vincular `pedido_items` a `inventario`
Supón que has creado la tabla `pedido_items` y ahora necesitas asegurar que todos los `producto_id` existan en `inventario`.
```sql
ALTER TABLE pedido_items
  ADD CONSTRAINT fk_pedidoitems_producto
  FOREIGN KEY (producto_id)
  REFERENCES inventario (id)
  ON DELETE RESTRICT; 
```
- Añade una restricción que impide insertar un `pedido_item` con `product_id` que no exista en `inventario`.
- Si se intenta eliminar un producto en `inventario` que está referenciado, la restricción `ON DELETE RESTRICT` previene la acción.
##### Eliminar una clave foránea
```sql
ALTER TABLE pedido_items
  DROP CONSTRAINT fk_pedidoitems_producto;
```
- Quita la restricción que vinculaba `pedido_items.producto_id` con `inventario.id`
- Después de esto, ya puedes borrar productos sin preocuparte por los ítems existentes
##### Hacer que la columna `descripcion_larga` no acepte valores nulos
```sql
ALTER TABLE inventario
  ALTER COLUMN descripcion_larga SET NOT NULL;
```
- Asegura que, a partir de ahora, ninguna fila en `inventario` puede tener `descripcion_larga` en `NULL`
- Si alguna fila existente tiene `descripcion_larga = NULL`, el comando fallará hasta que se actualice ese dato.
##### Quitar la restricción `NOT NULL` y permitir nulos en `descripcion_larga`
```sql
ALTER TABLE inventario
  ALTER COLUMN descripcion_larga DROP NOT NULL;
```
- Permite que `descripcion_larga` sea `NULL` de nuevo
- Útil si descubres que algunos productos no necesitan descripción extensa

---
### Ejecución en ventanas de mantenimiento
Para tablas muy grandes, es mejor:
1. Analizar si `ALTER TABLE` causará bloqueo total o `rewrite` en tu motor
2. Planificar el cambio en hora de baja actividad
3. Si es crítico no tener bloques considera:
	- Crear una tabla nueva con la estructura deseada
	- Copiar datos en `batches` (paginar mediante `LIMIT`/`OFFSET` o clave primaria)
	- Renombrar tablas dentro de una transacción:
```sql
BEGIN;
	ALTER TABLE inventario RENAME TO inventario_old;
	ALTER TABLE nueva_inventario RENAME TO inventario;
COMMIT;
```
*Así minimizas la ventana en que ninguna consulta puede usar la tabla original*.