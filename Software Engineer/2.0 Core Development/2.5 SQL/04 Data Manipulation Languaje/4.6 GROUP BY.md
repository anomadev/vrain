> [!info] GROUP BY (Roadmap SH)
> `GROUP BY` es una cláusula SQL utilizada en declaraciones `SELECT` para organizar datos idénticos en grupos. Generalmente se utiliza con funciones agregadas (como `COUNT`, `SUM`, `AVG`) para realizar cálculos en cada grupo de filas. `GROUP BY` recopila datos de varios registros y agrupa los resultados por una o más columnas, lo que permite el análisis de datos con un mayor nivel de granularidad. Esta cláusula es fundamental para generar informes resumidos, realizar análisis de datos y crear agregaciones significativas de datos en base de datos relacionales.

### Definición
La cláusula `GROUP BY` en SQL agrupa filas que comparten uno o más valores en columnas específicas, permitiendo luego aplicar funciones de agregación (como `COUNT`, `SUM`, `AVG`, `MIN`, `MAX`) sobre cada grupo. En lugar de operar fila por fila, `GROUP BY` produce resultados a nivel de grupo.

> [!info] Analogía
> Imagina una hoja de Excel donde tienes ventas con columnas "Vendedor" y "Monto". Si quieres saber cuánto vendió cada vendedor en total, primero "agrupas" todas las filas por vendedor, y luego sumas los montos de cada grupo.

### Conceptos Clave
##### Sintaxis básica
```sql
SELECT columna_agrupada, FUNC_AGG(columna)
FROM tabla
[WHERE condicion]
GROUP BY columna_agrupada;
```
- `columna_agrupada`: columna por la que se agruparán filas (p. ej. `vendedor_id`)
- `FUNC_AGG`: función de agregación como `COUNT(*)`, `SUM(monto)`, `AVG(precio)`, `MIN(fecha)`, `MAX(cantidad)`
##### Funciones de agregación más usadas
- `COUNT(*)`: cuesta dilas en cada grupo
- `SUM(columna)`: suma valores numéricos
- `AVG(columna)`: calcula promedio
- `MIN(columna)`/`MAX(columna)`: valor mínimo/máximo
##### `HAVING` para filtrar grupos
- Similar a `WHERE`, pero actúa después de agrupar
- `HAVING` filtra los resultados agregados, mientras que `WHERE` filtra antes de agrupar
```sql
SELECT columna_agrupada, SUM(columna)
FROM tabla
GROUP BY columna_agrupada
HAVING SUM(columna) > valor;
```
##### Agrupar múltiples columnas
- Cada combinación única de `(columna1, columna2)` forma un grupo
```sql
GROUP BY columna1, columna2
```
##### Orden en la consulta
1. `FROM`
2. `WHERE`
3. `GROUP BY`
4. `HAVING`
5. `SELECT` (con funciones de agregación)
6. `ORDER BY`
- No puedes usar en `SELECT` columnas que no estén en `GROUP BY` ni sean parte de una función de agregación.

### Ejemplos Prácticos
##### Total de ventas por vendedor
```sql
-- Una empresa quiere saber cuánto vendió cada vendedor en junio de 2025

SELECT vendedor_id,
	   SUM(monto) AS total_ventas
FROM ventas
WHERE fecha_venta BETWEEN '2025-06-01' AND '2025-05-30'
GROUP BY vendedor_id;
```
1. Filtra ventas en junio de 2025
2. Agrupar por `vendedor_id`
3. Suma `monto` en cada grupo, dando el total de ventas por vendedor
##### Contar perdidos por cliente y filtrar resultados
```sql
-- Queremos listar solo aquellos clientes que hayan hecho más de 5 pedidos

SELECT cliente_id,
	   COUNT(*) AS total_pedidos
FROM pedidos
WHERE fecha_pedido BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY cliente_id
HAVING COUNT(*) > 5
ORDER BY total_pedidos DESC;
```
1. Filtra pedidos de 2024
2. Agrupa por `cliente_id`
3. Cuenta cuántos pedidos (`COUNT(*)`) tiene cada cliente
4. Filtra grupos donde `COUNT(*) > 5` (solo clientes con más de 5 pedidos)
5. Ordena de mayor a menor número de pedidos
##### Promedio de calificaciones por curso
```sql
-- En una plataforma, queremos saber la calificación promedio por curso

SELECT curso_id,
	   AVG(calificacion) AS calif_promedio
FROM evaluaciones
GROUP BY curso_id;
```
- Agrupa evaluaciones por `curso_id` y calcula el promedio de `calificacion` en cada curso
##### Agrupar por múltiples columnas: ventas por región y mes
```sql
-- Analizar ventas agrupadas por region y mes de fecha_venta

SELECT region,
	   DATE_TRUNC('month', fecha_venta) AS mes,
	   SUM(monto) AS total_mes
FROM ventas
WHERE fecha_venta >= '2025-01-01'
GROUP BY region, DATE_TRUNC('month', fecha_venta)
ORDER BY region, mes;
```
1. Filtra ventas a partir del 1 de enero de 2025
2. Usa `DATE_TRUNC('month', fecha_venta)` para extraer el mes
3. Agrupa por combinación `(region, mes)`
4. Suma monto en cada grupo, mostrando total de ventas por región cada mes
