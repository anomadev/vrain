> [!info] HAVING (Roadmap SH)
> La cláusula `HAVING` se utiliza en combinación con la cláusula `GROUP BY` para filtrar los resultados de `GROUP BY`. Se utiliza para mencionar condiciones en las funciones de grupo, como `SUM`, `COUNT`, `AVG`, `MAX` o `MIN`. 
> Es importante tener un cuenta que la cláusula `WHERE` introduce condiciones en filas individuales, mientras que `HAVING` introduce condiciones en grupos creados por la cláusula `GROUP BY`.
> Tenga en cuenta también que `HAVING` se aplica a registros de grupo resumidos, mientras que `WHERE` se aplica a registros individuales.

### Definición
La cláusula `HAVING` en SQL permite filtrar grupos generados por `GROUP BY` según condiciones sobre las funciones de agregación o sobre valores de las columnas agrupadas. A diferencia de `WHERE`, que filtra filas individuales previo al agrupamiento, `HAVING` actúa después de que se han creado los grupos.

> [!info] Analogía
> Piensa que tienes una lista de ventas agrupadas por vendedor. Con `GROUP BY` creas una "pila" de ventas para cada vendedor. Con `HAVING` decides cuáles de esas pilas (grupos) cumplen una condición, como  "solo mostrar vendedores con al menos 10 ventas". Es como primero juntar facturas por vendedor y luego descartar las pilas pequeñas.

### Conceptos Clave
##### Actúa sobre grupos
```sql
SELECT columna, FUN_AGG(columna)
FROM tabla
GROUP BY columna
HAVING condicion_agrupada
```
- `HAVING` se aplica después de `GROUP BY`. Filtra los resultados ya agregados
##### Filtrar con funciones de agregación
```sql
HAVING COUNT(*) > 5
-- Solo grupos con más de 5 filas
```
- Permite usar `COUNT`, `SUM`, `AVG`, `MIN`, `MAX` en la condición `HAVING`
##### Diferencia entre `WHERE` y `HAVING`
- `WHERE`: filtra filas antes de agrupar. No admite funciones de agregación.
- `HAVING`: filtra grupos después de agrupar. Sí admite funciones de agregación. 
- Flujo de ejecución
	1. `FROM`
	2. `WHERE`
	3. `GROUP BY`
	4. `HAVING`
	5. `SELECT`
	6. `ORDER BY`
##### Combinar `WHERE` y `HAVING`
- `WHERE` reduce filas antes de agrupar, optimiza el conjunto
- `HAVING` refina resultados agregados
```sql
SELECT vendedor_id, SUM(monto_venta) AS total
FROM ventas
WHERE fecha_venta >= '2025-01-01'
GROUP BY vendedor_id
HAVING SUM(monto_venta) > 10000;
```
##### Filtrar por columnas agrupadas (sin función)
- Aunque suele usarse con agregados, `HAVING` también puede filtrar valores de columnas incluidas en `GROUP BY`.
```sql
SELECT depto, COUNT(*) AS num_emp
FROM empleados
GROUP BY depto
HAVING depto <> 'Recursos Humanos';
```

### Ejemplos Prácticos
##### Vendedor con al menos 10 ventas en junio 2025
```sql
-- La empresa quiere reconocer a los vendedores 
-- que hicieron al manos 10 ventas en ese mes

SELECT vendedor_id
	   COUNT(*) AS cantidad_ventas
FROM ventas
WHERE fecha_venta BETWEEN '2025-06-01' AND '2025-06-30'
GROUP BY vendedor_id
HAVING COUNT(*) >= 10
ORDER BY cantidad_ventas DESC;
```
1. Filtra ventas de junio 2025 (`WHERE`)
2. Agrupa por cada `vendedor_id`
3. Cuenta cuántas ventas tiene cada vendedor
4. Con `HAVING`, solo deja a los que tuvieron 10 o más ventas
5. Ordena de mayor a menor cantidad de ventas
##### Categorías de productos con ingreso total superior a $50,000
```sql
-- El gerente de finanzas desea ver solo las categorías 
-- que superaron $50000 en ventas

SELECT categoria,
	   SUM(precio * cantidad) AS ingresos_totales
FROM ventas_productos
GROUP BY categoria
HAVING SUM(precio * cantidad) > 50000
ORDER BY ingresos_totales DESC;
```
1. Agrupa filas de la tabla `ventas_productos` por `categoria`
2. Calcula `SUM(precio * cantidad)` para cada grupo
3. Con `HAVING`, filtra categorías con ingresos mayores a 50000
4. Ordena de mayor a menor ingreso total
##### Clientes que realizaron pedidos en más de 3 ciudades
```sql
-- Un banco quiere identificar clientes que hayan hecho comper en,
-- al menos, 4 ciudades distintas.

SELECT cliente_id,
	   COUNT(DISTINCT ciudad) AS num_ciudades
FROM ordenes
GROUP BY cliente_id
HAVING COUNT(DISTINCT ciudad) >= 4;
```
- Agrupa órdenes por cada `cliente_id`
- Usa `COUNT(DISTINCT ciudad)` para contar cuántas ciudades únicas tiene cada cliente
- Filtra con `HAVING` clientes con 4 o más ciudades
##### Departamentos con antigüedad promedio mayor a 5 años
```sql
-- Recursos Humanos quiere conocer departamentos deonde el prodio de antigüedad
-- de los empleados sea superior a 5 años

SELECT departamento,
	AVG(EXTRACT(YEAR FROM AGE(CURRENT_DATE, fecha_ingreso))) AS antiguedad_promedio
FROM empleados
GROUP BY departamento
HAVING AVG(EXTRACT(YEAR FROM AGE(CURRENT, fecha_ingreso))) > 5;
```
1. Calcula la antigüedad de cada empleado en años(`AGE` y `EXTRACT`)
2. Agrupa por `departamento`
3. Calcula promedio de antigüedad en cada grupo
4. Filtra departamentos con promedio > 5