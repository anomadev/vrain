> [!info] Cookies in API Design (Roadmap SH)
> Las cookies desempeñan un papel instrumental en el campo del diseño de API. Básicamente, las cookies son pequeños fragmentos de datos que se almacenan en el navegador de un usuario y que permiten sesiones HTTP con estado, almacenando información pertinente entre las comunicaciones del servidor. En el diseño de API, las cookies son especialmente útiles cuando se requiere autenticación. Pueden almacenar tokens de sesión, lo que permite a los usuarios mantener la sesión iniciada en varias sesiones o páginas web diferentes. Comprender las cookies y cómo funcionan es vital en el diseño de API para mantener las sesiones de usuario, brindar una mejor experiencia de usuario y proteger la información del usuario.

### Definición
Una Cookie es un pequeño fragmento de datos que un servidor envía al navegador web de un usuario. El navegador almacena este fragmento y lo envía de vuelta sin modificar en cada solicitud posterior al mismo servidor. Su propósito principal es recordar información de estado entre diferentes solicitudes HTTP, permitiendo funcionalidades como el mantenimiento de sesiones de usuario (`logins`), la personalización de sitios y el seguimiento del comportamiento del usuario. En esencia, las cookies son el mecanismo principal para hacer que el protocolo HTTP, que es sin estado, se sienta "con estado".

### Conceptos Clave
- **Mecanismo de funcionamiento**:
	1. **El servidor establece la cookie**: Cuando un cliente hace una solicitud, el servidor puede incluir en su respuesta la cabecera `Set-Cookie`.
	2. **El navegador almacena la cookie**: El navegador recibe la respuesta y almacena la cookie, asociándola con el dominio del servidor.
	3. **El navegador envía la cookie de vuelta**: En cada solicitud futura al mismo dominio, el navegador incluirá automáticamente la cabecera `Cookie` con los datos de la cookie almacenada.
- **Tipos de Cookies**:
	- **Cookies de Sesión**: No tienen fecha de expiración (`Expires`) ni duración máxima (`Max-Age`). Son temporales y se eliminan cuando el cliente cierra el navegador.
	- **Cookies Persistentes**: Tienen una fecha de expiración o una duración máxima. Se almacenan en el disco del usuario y persisten hasta que expiran, incluso si el navegador se cierra y se vuelve a abrir.
- **Atributos de las Cookies (Directivas de Control)**: Son la parte más importante para la seguridad y el alcance de una cookie. Se definen en la cabecera `Set-Cookie`.

|Atributo|Descripción|Ejemplo de Uso|
|:--|:--|:--|
|**`Expires`**|Fecha y hora exactas en que la cookie expirará. (Formato de fecha HTTP).|`Expires=Wed, 21 Oct 2025 07:28:00 GMT`|
|**`Max-Age`**|Duración de la cookie en segundos desde el momento en que se recibe. Tiene precedencia sobre `Expires`. Si es `0` o `-1`, la cookie se elimina.|`Max-Age=3600` (expira en 1 hora)|
|**`Domain`**|Especifica los hosts a los que se enviará la cookie. Si no se especifica, se usa el host del servidor, excluyendo subdominios.|`Domain=example.com`|
|**`Path`**|Indica la ruta dentro del host que debe existir en la URL solicitada para enviar la cabecera `Cookie`.|`Path=/api`|
|**`Secure`**|**Atributo de seguridad.** La cookie solo se enviará al servidor en solicitudes cifradas (HTTPS). **Siempre debe usarse para cookies sensibles.**|`Set-Cookie: ...; Secure`|
|**`HttpOnly`**|**Atributo de seguridad.** Impide que la cookie sea accesible a través de APIs de JavaScript del lado del cliente (como `document.cookie`). Es una defensa crucial contra ataques XSS (Cross-Site Scripting).|`Set-Cookie: ...; HttpOnly`|
|**`SameSite`**|**Atributo de seguridad.** Controla si una cookie se envía en solicitudes iniciadas desde sitios de terceros. Es la principal defensa contra ataques CSRF (Cross-Site Request Forgery). Puede tener tres valores: `Strict`, `Lax`, `None`.|`Set-Cookie: ...; SameSite=Strict`|
- `SameSite` en detalle:
	- `Strict`: La cookie solo se enviará si la solicitud se origina en el mismo sitio.
	- `Lax`: (Valor por defecto en la mayoría de los navegadores modernos). La cookie se envía en navegaciones del nivel superior (ej. al hacer clic en un enlace que lleva a tu sitio web desde otro), pero no en solicitudes de origen cruzado como las iniciadas por `POST`, `<img>` o `iframes`.
	- `None`: La cookie se enviara en todas las solicitudes, tanto del mismo sitio como de origen cruzado. Requiere que el atributo `Secure` también esté presente.

### Ejemplos Prácticos
#### Flujo de inicio de sesión de una API que usa cookies para la sesión:
##### El usuario envía sus credenciales para iniciar sesión
```http
POST /api/login HTTP/1.1
Host: myapp.com
Content-Type: application/json

{
  "username": "user1",
  "password": "correct-password"
}
```
##### El servidor valida las credenciales y establece una cookie de sesión
El servidor responde con un `200 OK` y una cabecera `Set-Cookie` que contiene el identificador de sesión. Nota el uso de los atributos de seguridad.
```http
HTTP/1.1 200 OK
Content-Type: application/json
Set-Cookie: sessionId=abc123xyz; Path=/; Secure; HttpOnly; SameSite=Strict

{
  "status": "Login successful"
}
```
##### El usuario intenta acceder a un recurso protegido
El navegador, al hacer la solicitud a `/api/profile`, automáticamente adjunta la cookie que almacenó previamente. El servidor utiliza el `sessionId` para identificar al usuario.
```http
GET /api/profile HTTP/1.1
Host: myapp.com
Cookie: sessionId=abc123xyz
```

### Notas
- **La seguridad no es opcional**: En el desarrollo moderno, cualquier cookie que almacene información sensible (como un ID de sesión) DEBE usar los atributos `Secure`, `HttpOnly` y `SameSite`. No usarlos es una negligencia de seguridad.
- **`SameSite=Lax` es el nuevo estándar razonable**: Los navegadores modernos lo usan por defecto, lo que ha mitigado una gran cantidad de ataques CSRF. Usa `Strict` para acciones de alta sensibilidad y `None` solo cuando sea absolutamente necesario para integraciones de terceros y siempre con `Secure`.
- **Cookies vs. Almacenamiento Web (`Local Storage` / `Session Storage`)**: La principal ventaja de las cookies para almacenar tokens de sesión en el atributo `HttpOnly`. Los tokens guardados en `Local Storage` son vulnerables a ser robados por ataques `XSS`, ya que son accesibles por JavaScript. Si bien las cookies son vulnerables a `CSRF`, este riesgo se mitiga en gran medida con `SameSite`. Esta es una compensación de seguridad fundamental en el diseño de la autenticación web.
- **No almacenes datos grandes en cookies**: Las cookies se envían con cada solicitud HTTP al mismo dominio, lo que puede aumentar la latencia si son grandes. Están diseñadas para pequeños identificadores, no para almacenar grandes volúmenes de datos.