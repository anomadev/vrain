> [!info] CORS bajo diseño de API (Roadmap SH)
> El intercambio de recursos entre orígenes (`CORS`) es un concepto crucial en el diseño de API. Se trata de un mecanismo que utiliza encabezados HTTP para indicar a los navegadores que permitan a una aplicación web que se ejecuta en un origen acceder a recursos selecciones de un origen diferente. De forma predeterminada, los navegadores web prohíben que las páginas web realicen solicitudes a un dominio diferente de aquel del que proviene la página web. `CORS` es la guía que le permite configurar un conjunto de reglas en el servidor para definir qué tipos de solicitudes entre dominios están permitidas, brindando la flexibilidad necesaria sin comprometer la seguridad. Comprender `CORS` es crucial para diseñar API que garanticen una comunicación entre dominios segura y efectiva.
 
### Definición
`CORS (Cross-Origin Resource Sharing)` o "Intercambio de Recursos de Origen Cruzado" es un mecanismo de seguridad basado en cabeceras HTTP que permite a un servidor indicar cualquier origen (dominio, esquema o puerto) distinto al suyo desde el cual un navegador debería permitir la carga de recursos. Es, en esencia, una forma controlada de relajar la `Same-Origin Policy` (Política del Mismo Origen), una política de seguridad fundamental implementada por los navegadores web. Son  `CORS`, un script en una página web solo podría solicitar recursos que provengan del mismo origen que la página misma.

### Conceptos Clave
- Política del Mismo Origen (`Same-Origin Policy - SOP`): Este es el punto de partida. Es una regla de seguridad crítica que los navegadores aplican para evitar que un script en `sitio-a.com` pueda leer datos de `sitio-b.com` sin permiso. Un "origen" se define por la combinación de esquema (protocolo), host (dominio) y puerto. Si alguno de estos tres elementos es diferente, los orígenes son distintos.
	- `https://miapi.com` y `http://miapi.com` -> Origen cruzado (esquema diferente)
	- `https://miapi.com` y `https://www.miapi.com` -> Origen cruzado (dominio diferente)
	- `https://miapi.com` y `https://miapi.com:8080` -> Origen cruzado (puerto diferente)
- El problema que resuelve `CORS`: En la web moderna, es muy común que una aplicación web (ej. `https:///mi-frontend.com`) necesite consumir datos de una API alojada en otro dominio (ej. `https://api.mi-backend.com`). Por defecto, la SOP del navegador bloquearía esta solicitud. `CORS` proporciona un mecanismo para que el servidor de la API (`api.mi-backend.com`) le diga al navegador: "Confío en `https://mi-frontend.com`, permítele hacer esta solicitud".
- Solicitud "`Preflight`" (Vuelo Previo): Este es el concepto más importante de `CORS`. Antes de enviar una solicitud que podría modificar datos en el servidor (como un `POST` con `Content-Type: application/json`, un `PUT`, o un `DELETE`), el navegador automáticamente envía primero una solicitud de "verificación" usando el método `OPTIONS`.
	1. Propósito: La solicitud `OPTIONS` pregunta al servidor si la solicitud real es segura de enviar.
	2. Funcionamiento: El navegador envía la cabecera `Origin` (de dónde viene la solicitud), `Access-Control-Request-Method` (qué método HTTP se usará) y `Access-Control-Request-Headers` (qué cabeceras se incluirán).
	3. Respuesta del Servidor: El servidor debe responder a esta solicitud `OPTIONS` con cabeceras `Acces-Control-Allow-*` que confirmen si el origen, el método y las cabeceras están permitidos.
	4. Decisión del Navegador: Si la respuesta a la solicitud `OPTIONS` es afirmativa, el navegador procede a enviar la solicitud real (`POST`, `PUT`, etc.) Si no, el navegador bloquea la solicitud y muestra un error de `CORS` en la consola.
- Cabeceras HTTP Clave de CORS:
	- Cabeceras de Solicitud (enviadas por el navegador):
		- `Origin`: Indica el origen desde el que se realiza la solicitud (ej. `Origin: https://mi-frontend.com`)
		- `Access-Control-Request-Method`: Se usa en la solicitud `OPTIONS` para indicar qué método se usará en la solicitud real.
		- `Access-Control-Request-Headers`: Se usa en la solicitud `OPTIONS` para indicar qué cabeceras se usarán en la solicitud real.
	- Cabeceras de Respuesta (configuradas por el servidor):
		- `Access-Control-Allow-Origin`: La cabecera más importante. Especifica qué origen tiene permiso. Puede ser un origen específico (ej. `https://mi-frontend.com`) o un comodín `*` (permite cualquier origen).
		- `Access-Control-Allow-Methods`: Especifica los métodos HTTP permitidos (ej. `GET`, `POST`, `OPTIONS`, `PUT`).
		- `Access-Control-Allow-Headers`: Especifica las cabeceras HTTP permitidas en la solicitud real.
		- `Access-Control-Allow-Credentials`: Permite que las cookies y otras credenciales se incluyan en la solicitud de origen cruzado. Si se usa, `Access-Control-Allow-Origin` no puede ser `*`.

### Ejemplos Prácticos
#### Flujo de una solicitud `POST` de origen cruzado con `preflight`:
Una aplicación en `https://mi-app.com` quiere crear un usuario enviando un JSON a `https://api.externa.com/users`.
##### Solicitud `OPTIONS` (`preflight`) enviada automáticamente por el navegador
```http
OPTIONS /users HTTP/1.1
Host: api.externa.com
Origin: https://mi-app.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Content-Type, Authorization
```
##### Respuesta del Servidor a la solicitud `OPTIONS`:
El servidor confirma que acepta solicitudes `POST` con las cabeceras `Content-Type` y `Authorization` desde el origen `https://mi-app.com`.
```http
HTTP/1.1 204 No Content
Access-Control-Allow-Origin: https://mi-app.com
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Max-Age: 86400
```
##### Solicitud `POST` real enviada por el navegador (solo si el paso 2 fue exitoso):
Ahora que el navegador tiene permiso, envía la solicitud `POST` original.
```http
POST /users HTTP/1.1
Host: api.externa.com
Origin: https://mi-app.com
Content-Type: application/json
Authorization: Bearer <token>

{ "name": "Steve Rogers" }
```

### Notas
- **Cuidado con el comodín (`*`)**: Usar `Access-Control-Allow-Origin: *` es la solicitud fácil, pero a menudo incorrecta para `APIs` que no son 100% publicas. Si tu API maneja datos sensibles y requiere autenticación, siempre debes especificar explícitamente los orígenes permitidos.
- **Herramientas como `Postman` no usan CORS**: Es común que una solicitud funciones en `Postman` pero fallen en el navegador. Esto se debe a que `Postman` (y otras herramientas de servidor como `cURL`) no son navegadores y no implementan la Política del Mismo Origen. El mecanismo de CORS es una capa de seguridad impuesta por el navegador para proteger al usuario final.